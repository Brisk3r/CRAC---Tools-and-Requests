<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Admin | Clarence Regional Aquatic Centre</title>
    
    <!-- Tailwind CSS v2 (no bracket syntax, no /opacity modifiers) -->
    <link href="https://unpkg.com/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.2s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .text-10 { font-size: 10px; line-height: 1.4; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); }
        .bg-gray-50-50 { background-color: rgba(249, 250, 251, 0.5); }
        
        /* Re-engineered Print Utilities */
        @media print {
            @page { size: landscape; margin: 8mm; }
            
            body, html { 
                height: auto !important; 
                min-height: 0 !important; 
                overflow: visible !important; 
                background-color: white !important; 
            }
            .min-h-screen { 
                min-height: 0 !important; 
                padding-bottom: 0 !important; 
                background-color: white !important; 
            }
            
            .print-exact { -webkit-print-color-adjust: exact; print-color-adjust: exact; color-adjust: exact; }
            .print-hide { display: none !important; }
            .print-page-break { break-after: page; page-break-after: always; }
            .print-break-inside-avoid { break-inside: avoid; page-break-inside: avoid; }
            
            /* Completely detaches modal from viewport for native page printing */
            .print-modal-wrapper {
                position: static !important;
                display: block !important;
                width: 100% !important;
                height: auto !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
                background: white !important;
            }

            /* Force the table to compress to fit perfectly on A4 landscape */
            table { border-collapse: collapse !important; width: 100% !important; }
            tr { break-inside: avoid !important; page-break-inside: avoid !important; }
            
            /* Tightly control cell height so 15 rows fit vertically */
            .print-cell-wrapper {
                min-height: 38px !important; 
                padding: 2px !important;
            }
            .print-text-sm {
                font-size: 10px !important;
                line-height: 1.15 !important;
            }

            /* Ensure backgrounds render faithfully */
            .bg-green-50 { background-color: #f0fdf4 !important; }
            .bg-yellow-100 { background-color: #fef9c3 !important; }
            .bg-red-100 { background-color: #fee2e2 !important; }
            .bg-gray-100 { background-color: #f3f4f6 !important; }
            .bg-gray-200 { background-color: #e5e7eb !important; }
            .border-gray-200 { border-color: #e5e7eb !important; }
            .border-gray-300 { border-color: #d1d5db !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 antialiased">
    <div id="root"></div>

    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase Compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <script type="text/babel">
        const Icons = {
            Search: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Edit: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            Trash: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>,
            X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 12"/></svg>,
            Repeat: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>,
            LogOut: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            AlertTriangle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Database: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            ChevronLeft: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            List: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
            Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Printer: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
        };

        const { useState, useEffect, useMemo } = React;

        const HIDDEN_ADMIN_EMAIL = "info@clarenceregionalaquaticcentre.com.au";
        const TARGET_VENUE = 'CRAC'; 

        const CRAC_DEFAULTS = { 
            zones: [ 
                { id: '50m Pool', children: Array.from({length: 8}, (_, i) => ({id: `Lane ${i+1}`})) }, 
                { id: 'LTS Pool', children: [] }, 
                { id: 'Splash Park', children: [] }, 
                { id: 'Multi-Purpose Room', children: [] } 
            ], 
            eventTypes: { 
                'Learn to Swim': '#3B82F6', 
                'Aqua Fitness': '#10B981', 
                'Public Swim': '#F59E0B', 
                'School Carnival': '#EF4444', 
                'Lane Hire': '#8B5CF6' 
            },
            openingHours: [ 
                {day: 'Monday', open: 5, close: 19}, {day: 'Tuesday', open: 5, close: 19}, 
                {day: 'Wednesday', open: 5, close: 19}, {day: 'Thursday', open: 5, close: 19}, 
                {day: 'Friday', open: 5, close: 19}, {day: 'Saturday', open: 8, close: 18}, 
                {day: 'Sunday', open: 8, close: 18} 
            ]
        };

        const firebaseConfig = {
            apiKey: "AIzaSyAF44-oMKqTKPcMgOuKfJJqUTJz9JYTHAg",
            authDomain: "osf---availability-roster.firebaseapp.com",
            projectId: "osf---availability-roster",
            storageBucket: "osf---availability-roster.firebasestorage.app",
            messagingSenderId: "1069751236100",
            appId: "1:1069751236100:web:2832210ad7e9ed50e86751",
            measurementId: "G-K5F1SSNK5H"
        };

        let db, auth;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }

        const App = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [user, setUser] = useState(null);
            const [firebaseReady, setFirebaseReady] = useState(false);

            useEffect(() => {
                const initAuth = async () => {
                    try { await auth.signInAnonymously(); } 
                    catch (err) { console.error("Auth Error:", err); }
                };
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u && !u.isAnonymous) { setUser(u); setIsAuthenticated(true); } 
                    else { setUser(null); setIsAuthenticated(false); }
                    setFirebaseReady(true);
                });
                initAuth();
                return () => unsubscribe();
            }, []);

            const handleLogout = async () => {
                await auth.signOut();
                await auth.signInAnonymously();
            };

            if (!firebaseReady) return (
                <div className="h-screen flex flex-col items-center justify-center text-gray-500" style={{gap: '1rem'}}>
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p>Connecting to CRAC System...</p>
                </div>
            );
            if (!isAuthenticated) return <Login />;
            return <AdminPage onLogout={handleLogout} user={user} />;
        };

        const Login = () => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoggingIn, setIsLoggingIn] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoggingIn(true);
                setError('');
                try {
                    await auth.signInWithEmailAndPassword(HIDDEN_ADMIN_EMAIL, password);
                } catch (err) {
                    if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found' || err.code === 'auth/invalid-email') {
                        setError('Incorrect password.');
                    } else {
                        setError(`Connection error: ${err.message}`);
                    }
                    setIsLoggingIn(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm fade-in">
                        <div className="text-center mb-8">
                            <h1 className="text-2xl font-bold text-blue-900">Admin Portal</h1>
                            <p className="text-gray-500 text-sm mt-1">Clarence Regional Aquatic Centre</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Access Password</label>
                                <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Enter password" autoFocus />
                            </div>
                            {error && <p className="text-red-500 text-sm bg-red-50 p-2 rounded border border-red-100">{error}</p>}
                            <button
                                type="submit"
                                disabled={isLoggingIn}
                                style={{opacity: isLoggingIn ? 0.5 : 1, cursor: isLoggingIn ? 'not-allowed' : 'pointer'}}
                                className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm"
                            >
                                {isLoggingIn ? 'Verifying...' : 'Login'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const AdminPage = ({ onLogout, user }) => {
            const [events, setEvents] = useState([]);
            const [settings, setSettings] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [dbStatus, setDbStatus] = useState("Initializing...");
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isExportOpen, setIsExportOpen] = useState(false);
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [viewMode, setViewMode] = useState('list');
            const [searchTerm, setSearchTerm] = useState('');
            const [dateFilter, setDateFilter] = useState('future');
            const [zoneFilter, setZoneFilter] = useState('all');
            const [typeFilter, setTypeFilter] = useState('all');
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 20;

            const paths = useMemo(() => ({ events: 'calendar_events', settings: 'calendar_settings' }), []);

            useEffect(() => {
                if (!db || !user) return;
                let settingsLoaded = false, eventsLoaded = false;
                const checkLoading = () => { if (settingsLoaded && eventsLoaded) { setIsLoading(false); setDbStatus("Connected"); } };

                const unsubSettings = db.collection(paths.settings).doc('main_config').onSnapshot(doc => {
                    setSettings(doc.exists ? doc.data() : null);
                    settingsLoaded = true; checkLoading();
                }, err => { setDbStatus(`Error: ${err.message}`); settingsLoaded = true; checkLoading(); });

                const unsubEvents = db.collection(paths.events).onSnapshot(snapshot => {
                    const fetched = snapshot.docs.map(doc => {
                        const d = doc.data();
                        return { id: doc.id, ...d,
                            startDateTime: d.startDateTime?.toDate ? d.startDateTime.toDate() : new Date(d.startDateTime),
                            endDateTime: d.endDateTime?.toDate ? d.endDateTime.toDate() : new Date(d.endDateTime) };
                    });
                    fetched.sort((a,b) => a.startDateTime - b.startDateTime);
                    setEvents(fetched);
                    eventsLoaded = true; checkLoading();
                }, err => { setDbStatus(`Error: ${err.message}`); eventsLoaded = true; checkLoading(); });

                return () => { unsubSettings(); unsubEvents(); };
            }, [paths, user]);

            const initializeDatabase = async () => {
                if (!window.confirm("Initialize database with CRAC default settings?")) return;
                try { await db.collection(paths.settings).doc('main_config').set(CRAC_DEFAULTS); }
                catch(err) { alert("Initialization failed: " + err.message); }
            };

            const openModal = (event = null) => {
                if (event?.isInstance) {
                    const original = events.find(e => e.id === event.id);
                    setSelectedEvent(original || event);
                } else {
                    setSelectedEvent(event);
                }
                setIsModalOpen(true);
            };

            const closeModal = () => { setIsModalOpen(false); setSelectedEvent(null); };

            const handleSaveEvent = async (eventData) => {
                try {
                    const dataToSave = { ...eventData, venue: TARGET_VENUE };
                    if (selectedEvent) { await db.collection(paths.events).doc(selectedEvent.id).update(dataToSave); }
                    else { await db.collection(paths.events).add(dataToSave); }
                    closeModal();
                } catch (err) { alert("Error saving: " + err.message); }
            };

            const handleDeleteEvent = async (id) => {
                if (!window.confirm('Delete this event?')) return;
                try { await db.collection(paths.events).doc(id).delete(); } catch(err) { alert("Delete failed: " + err.message); }
            };

            const handleBatchDelete = async (ids) => {
                if (!ids || ids.length === 0) return;
                if (!window.confirm(`Are you sure you want to delete ${ids.length} past events? This cannot be undone.`)) return;
                try {
                    const batchSize = 400;
                    for (let i = 0; i < ids.length; i += batchSize) {
                        const batch = db.batch();
                        ids.slice(i, i + batchSize).forEach(id => batch.delete(db.collection(paths.events).doc(id)));
                        await batch.commit();
                    }
                    alert("Cleanup complete. Database is now tidy.");
                } catch (err) { alert("Error deleting events: " + err.message); }
            };

            const handleSaveSettings = async (newSettings) => {
                try { await db.collection(paths.settings).doc('main_config').set(newSettings, { merge: true }); }
                catch(err) { alert("Save failed: " + err.message); }
            };

            const expandedEvents = useMemo(() => {
                if (viewMode === 'list') return events;
                const expanded = [];
                const now = new Date();
                const startRange = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const endRange = new Date(now.getFullYear(), now.getMonth() + 4, 0);

                events.forEach(event => {
                    if (searchTerm && !event.title.toLowerCase().includes(searchTerm.toLowerCase())) return;
                    if (typeFilter !== 'all' && event.type !== typeFilter) return;
                    if (zoneFilter !== 'all') {
                        const zones = Array.isArray(event.zone) ? event.zone : [event.zone];
                        if (!zones.some(z => z === zoneFilter)) return;
                    }
                    if (event.recurrence && event.recurrence.days) {
                        let current = new Date(event.startDateTime); current.setHours(0,0,0,0);
                        const endRecur = event.recurrence.endDate.toDate ? event.recurrence.endDate.toDate() : new Date(event.recurrence.endDate);
                        const effectiveEnd = new Date(Math.min(endRecur.getTime(), endRange.getTime()));
                        if (current < startRange) current = new Date(startRange);
                        const startTime = { h: event.startDateTime.getHours(), m: event.startDateTime.getMinutes() };
                        
                        // Protective Duration Cap 
                        let duration = event.endDateTime.getTime() - event.startDateTime.getTime();
                        if (duration > 24 * 60 * 60 * 1000) {
                            const hDiff = event.endDateTime.getHours() - event.startDateTime.getHours();
                            const mDiff = event.endDateTime.getMinutes() - event.startDateTime.getMinutes();
                            duration = (hDiff * 60 + mDiff) * 60000;
                            if (duration < 0) duration += 24 * 60 * 60 * 1000;
                        }

                        while(current <= effectiveEnd) {
                            const dayName = current.toLocaleDateString('en-US', { weekday: 'long' });
                            if (event.recurrence.days.includes(dayName)) {
                                const s = new Date(current); s.setHours(startTime.h, startTime.m, 0, 0);
                                expanded.push({ ...event, startDateTime: s, endDateTime: new Date(s.getTime() + duration), isInstance: true });
                            }
                            current.setDate(current.getDate() + 1);
                        }
                    } else {
                        if (event.startDateTime >= startRange && event.startDateTime <= endRange) expanded.push(event);
                    }
                });
                return expanded.sort((a,b) => a.startDateTime - b.startDateTime);
            }, [events, viewMode, searchTerm, typeFilter, zoneFilter]);

            const filteredEventsList = useMemo(() => {
                const now = new Date();
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                const endOfWeek = new Date(today); endOfWeek.setDate(today.getDate() + 6);
                return events.filter(event => {
                    if (searchTerm && !event.title.toLowerCase().includes(searchTerm.toLowerCase())) return false;
                    if (zoneFilter !== 'all') {
                        const zones = Array.isArray(event.zone) ? event.zone : [event.zone];
                        if (!zones.some(z => z === zoneFilter)) return false;
                    }
                    if (typeFilter !== 'all' && event.type !== typeFilter) return false;
                    const eventStart = new Date(event.startDateTime); eventStart.setHours(0,0,0,0);
                    let effectiveEnd = new Date(event.endDateTime);
                    if (event.recurrence && event.recurrence.endDate) {
                        const recEnd = event.recurrence.endDate.toDate ? event.recurrence.endDate.toDate() : new Date(event.recurrence.endDate);
                        effectiveEnd = new Date(recEnd);
                    }
                    effectiveEnd.setHours(23, 59, 59, 999);
                    if (dateFilter === 'today') {
                        if (!event.recurrence) return eventStart.getTime() === today.getTime();
                        if (today < eventStart || today > effectiveEnd) return false;
                        const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });
                        return event.recurrence.days && event.recurrence.days.includes(dayName);
                    }
                    if (dateFilter === 'week') return eventStart <= endOfWeek && effectiveEnd >= today;
                    if (dateFilter === 'future') return effectiveEnd >= today;
                    return true;
                });
            }, [events, searchTerm, dateFilter, zoneFilter, typeFilter]);

            const groupedEventsList = useMemo(() => {
                const groups = {};
                const startIndex = (currentPage - 1) * itemsPerPage;
                filteredEventsList.slice(startIndex, startIndex + itemsPerPage).forEach(event => {
                    const dateKey = event.startDateTime.toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short' });
                    if (!groups[dateKey]) groups[dateKey] = [];
                    groups[dateKey].push(event);
                });
                return groups;
            }, [filteredEventsList, currentPage]);

            const totalPages = Math.ceil(filteredEventsList.length / itemsPerPage);

            const allZonesFlat = useMemo(() => {
                const z = [];
                if (settings && settings.zones) {
                    settings.zones.forEach(zone => {
                        z.push(zone.id);
                        if(zone.children) zone.children.forEach(c => z.push(c.id));
                    });
                }
                return z.sort();
            }, [settings]);

            const formatZoneList = (zones) => {
                if (!Array.isArray(zones) || zones.length === 0) return "-";
                if (zones.length <= 2) return zones.join(", ");
                return `${zones[0]} + ${zones.length - 1} others`;
            };

            if (isLoading) return <div className="h-screen flex items-center justify-center text-gray-500">Loading Database...</div>;

            return (
                <div className="min-h-screen bg-gray-50 pb-20">
                    <header className="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-20 print-hide">
                        <div className="container mx-auto px-4 py-3 flex flex-col md:flex-row justify-between items-center" style={{gap: '1rem'}}>
                            <div className="flex items-center" style={{gap: '0.75rem'}}>
                                <div className="bg-blue-600 text-white p-2 rounded-lg"><Icons.Settings size={20} /></div>
                                <div>
                                    <h1 className="text-xl font-bold text-gray-900 leading-none">Calendar Admin</h1>
                                    <div className="flex items-center mt-1" style={{gap: '0.5rem'}}>
                                        <span className="text-xs text-gray-500 font-medium uppercase tracking-wide">{TARGET_VENUE}</span>
                                        <span className={`text-xs px-1 py-0 rounded-full ${dbStatus.includes('Error') ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`} style={{fontSize: '10px'}}>{dbStatus}</span>
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center" style={{gap: '0.75rem'}}>
                                <button onClick={() => setIsSettingsOpen(true)} className="flex items-center gap-2 px-3 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors text-sm font-medium"><Icons.Settings size={16} /> Config</button>
                                <button onClick={onLogout} className="flex items-center gap-2 px-3 py-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors text-sm font-medium"><Icons.LogOut size={16} /> Logout</button>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto px-4 py-6 print-hide">
                        {!settings && (
                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-8 flex flex-col items-center justify-center text-center">
                                <Icons.AlertTriangle className="text-yellow-600 mb-2" size={32} />
                                <h3 className="text-lg font-bold text-yellow-800">Configuration Not Found</h3>
                                <button onClick={initializeDatabase} className="mt-3 bg-blue-600 text-white px-6 py-2 rounded-lg font-bold hover:bg-blue-700 shadow-sm flex items-center gap-2"><Icons.Database size={18} /> Initialize Database Settings</button>
                            </div>
                        )}

                        {/* TOOLBAR */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6 flex flex-col lg:flex-row items-center justify-between" style={{gap: '1rem'}}>
                            <div className="flex flex-col md:flex-row w-full lg:w-auto items-center" style={{gap: '0.75rem'}}>
                                <div className="relative w-full md:w-64">
                                    <Icons.Search className="absolute text-gray-400" style={{left: '0.75rem', top: '50%', transform: 'translateY(-50%)'}} size={18} />
                                    <input type="text" placeholder="Search events..." value={searchTerm} onChange={e => { setSearchTerm(e.target.value); setCurrentPage(1); }} className="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none w-full" />
                                </div>

                                {/* View Toggle */}
                                <div className="flex bg-gray-100 p-1 rounded-lg border border-gray-200 flex-shrink-0">
                                    <button onClick={() => setViewMode('list')} className={`p-2 rounded ${viewMode === 'list' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500 hover:text-gray-700'}`} title="List View"><Icons.List size={18} /></button>
                                    <button onClick={() => setViewMode('calendar')} className={`p-2 rounded ${viewMode === 'calendar' ? 'bg-white shadow-sm text-blue-600' : 'text-gray-500 hover:text-gray-700'}`} title="Calendar View"><Icons.Calendar size={18} /></button>
                                </div>

                                {viewMode === 'list' && (
                                    <select value={dateFilter} onChange={e => { setDateFilter(e.target.value); setCurrentPage(1); }} className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm">
                                        <option value="future">Upcoming</option>
                                        <option value="today">Today Only</option>
                                        <option value="week">Next 7 Days</option>
                                        <option value="all">All Events</option>
                                    </select>
                                )}

                                <select value={typeFilter} onChange={e => { setTypeFilter(e.target.value); setCurrentPage(1); }} className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm">
                                    <option value="all">All Types</option>
                                    {settings && Object.keys(settings.eventTypes).map(t => <option key={t} value={t}>{t}</option>)}
                                </select>

                                <select value={zoneFilter} onChange={e => { setZoneFilter(e.target.value); setCurrentPage(1); }} style={{maxWidth: '200px'}} className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white text-sm">
                                    <option value="all">All Zones</option>
                                    {allZonesFlat.map(z => <option key={z} value={z}>{z}</option>)}
                                </select>
                            </div>
                            <div className="flex items-center gap-3 w-full lg:w-auto">
                                <button onClick={() => setIsExportOpen(true)} className="flex-1 lg:flex-none flex items-center justify-center gap-2 bg-gray-800 text-white px-5 py-2 rounded-lg font-bold hover:bg-gray-900 transition-colors shadow-sm whitespace-nowrap"><Icons.Printer size={18} /> Export Timetable</button>
                                <button onClick={() => openModal()} className="flex-1 lg:flex-none flex items-center justify-center gap-2 bg-blue-600 text-white px-5 py-2 rounded-lg font-bold hover:bg-blue-700 transition-colors shadow-sm whitespace-nowrap"><Icons.Plus size={18} /> Add Event</button>
                            </div>
                        </div>

                        {/* LIST VIEW */}
                        {viewMode === 'list' && (
                            <div className="space-y-6">
                                {Object.keys(groupedEventsList).length === 0 ? (
                                    <div className="text-center py-12 bg-white rounded-xl border border-gray-200 text-gray-500">No events found matching your filters.</div>
                                ) : (
                                    Object.entries(groupedEventsList).map(([date, dayEvents]) => (
                                        <div key={date} className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                                            <div className="bg-gray-50 px-4 py-2 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                                                <span>{date}</span>
                                                <span className="text-xs font-normal text-gray-500">{dayEvents.length} events</span>
                                            </div>
                                            <div className="divide-y divide-gray-100">
                                                {dayEvents.map(event => (
                                                    <div key={event.id} className="p-4 hover:bg-blue-50 transition-colors flex flex-col sm:flex-row sm:items-center justify-between group" style={{gap: '1rem'}}>
                                                        <div className="flex items-start flex-1" style={{gap: '0.75rem'}}>
                                                            <div className="flex-shrink-0 text-sm text-gray-600 font-medium pt-1" style={{width: '7rem'}}>
                                                                <span>
                                                                    {event.startDateTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                                                    {' â€“ '}
                                                                    {event.endDateTime.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}
                                                                </span>
                                                            </div>
                                                            <div className="flex-1 min-w-0">
                                                                <div className="flex items-center gap-2">
                                                                    <h4 className="font-bold text-gray-900 truncate">{event.title}</h4>
                                                                    {event.recurrence && <Icons.Repeat size={14} className="text-blue-500 flex-shrink-0" title="Recurring Event" />}
                                                                </div>
                                                                <div className="flex flex-wrap mt-1" style={{gap: '0.5rem'}}>
                                                                    <span className="text-10 uppercase font-bold px-2 py-0 rounded text-white" style={{ backgroundColor: settings?.eventTypes?.[event.type] || '#9ca3af' }}>{event.type}</span>
                                                                    <span className="text-xs text-gray-600 bg-gray-100 px-2 rounded border border-gray-200 truncate" style={{maxWidth: '200px'}} title={Array.isArray(event.zone) ? event.zone.join(', ') : event.zone}>
                                                                        {formatZoneList(event.zone)}
                                                                    </span>
                                                                </div>
                                                                {event.description && <p className="text-sm text-gray-500 mt-1 truncate">{event.description}</p>}
                                                                {event.recurrence && event.recurrence.days && (
                                                                    <p className="text-xs text-blue-600 mt-0.5">Weekly on {event.recurrence.days.map(d=>d.slice(0,3)).join(', ')}</p>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="flex gap-2 self-end sm:self-center">
                                                            <button onClick={() => openModal(event)} className="p-2 text-gray-500 hover:text-blue-600 hover:bg-blue-100 rounded transition-colors"><Icons.Edit size={18} /></button>
                                                            <button onClick={() => handleDeleteEvent(event.id)} className="p-2 text-gray-500 hover:text-red-600 hover:bg-red-100 rounded transition-colors"><Icons.Trash size={18} /></button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))
                                )}
                                {totalPages > 1 && (
                                    <div className="mt-6 flex justify-center items-center gap-4">
                                        <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="p-2 rounded-lg border bg-white hover:bg-gray-50" style={{opacity: currentPage === 1 ? 0.5 : 1}}><Icons.ChevronLeft size={20} /></button>
                                        <span className="text-sm font-medium text-gray-600">Page {currentPage} of {totalPages}</span>
                                        <button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} className="p-2 rounded-lg border bg-white hover:bg-gray-50" style={{opacity: currentPage === totalPages ? 0.5 : 1}}><Icons.ChevronRight size={20} /></button>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* CALENDAR VIEW */}
                        {viewMode === 'calendar' && <CalendarView events={expandedEvents} onEdit={openModal} onDelete={handleDeleteEvent} eventTypes={settings?.eventTypes} />}
                    </main>

                    {isModalOpen && <EventForm event={selectedEvent} onSave={handleSaveEvent} onClose={closeModal} settings={settings || CRAC_DEFAULTS} />}
                    {isSettingsOpen && <SettingsModal settings={settings || CRAC_DEFAULTS} events={events} onSave={handleSaveSettings} onDeleteBatch={handleBatchDelete} onClose={() => setIsSettingsOpen(false)} />}
                    {isExportOpen && <ExportModal settings={settings || CRAC_DEFAULTS} events={events} onClose={() => setIsExportOpen(false)} />}
                </div>
            );
        };

        // CALENDAR VIEW
        const CalendarView = ({ events, onEdit, onDelete, eventTypes }) => {
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const startOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const endOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const startDay = new Date(startOfMonth); startDay.setDate(1 - startDay.getDay());
            const endDay = new Date(endOfMonth); endDay.setDate(endOfMonth.getDate() + (6 - endOfMonth.getDay()));
            const days = [];
            let d = new Date(startDay);
            while (d <= endDay) { days.push(new Date(d)); d.setDate(d.getDate() + 1); }

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden fade-in">
                    <div className="p-4 flex justify-between items-center border-b border-gray-200">
                        <h2 className="text-lg font-bold text-gray-900">{currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                        <div className="flex gap-2">
                            <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))} className="p-1 hover:bg-gray-100 rounded"><Icons.ChevronLeft /></button>
                            <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))} className="p-1 hover:bg-gray-100 rounded"><Icons.ChevronRight /></button>
                        </div>
                    </div>
                    <div className="grid grid-cols-7 text-center text-xs font-semibold text-gray-500 border-b border-gray-200 bg-gray-50">
                        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => <div key={day} className="py-2">{day}</div>)}
                    </div>
                    <div className="grid grid-cols-7 divide-x divide-gray-200" style={{gridAutoRows: 'minmax(120px, auto)'}}>
                        {days.map(day => {
                            const dayEvents = events.filter(e => e.startDateTime.toDateString() === day.toDateString());
                            const isCurr = day.getMonth() === currentMonth.getMonth();
                            return (
                                <div key={day.toISOString()} className={`p-2 flex flex-col gap-1 ${isCurr ? 'bg-white text-gray-800' : 'text-gray-400'}`} style={{backgroundColor: isCurr ? '' : 'rgba(249,250,251,0.5)'}}>
                                    <div className="text-right text-xs font-medium mb-1">{day.getDate()}</div>
                                    <div className="flex flex-col gap-1 overflow-y-auto no-scrollbar" style={{maxHeight: '150px'}}>
                                        {dayEvents.map(e => (
                                            <div key={e.id + e.startDateTime.toISOString()} onClick={() => onEdit(e)}
                                                className="text-10 p-1 rounded cursor-pointer text-white truncate shadow-sm hover:opacity-75 transition-opacity"
                                                style={{ backgroundColor: eventTypes?.[e.type] || '#9ca3af' }}>
                                                <span className="font-bold mr-1">{e.startDateTime.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'})}</span>
                                                {e.title}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // EVENT FORM
        const EventForm = ({ event, onSave, onClose, settings }) => {
            const [formData, setFormData] = useState({ title: '', description: '', zone: [], type: '', recurrence: null });
            const [startDateTime, setStartDateTime] = useState('');
            const [endDateTime, setEndDateTime] = useState('');

            const toLocalISOString = (date) => {
                if (!date) return '';
                const d = new Date(date);
                const pad = n => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
            };

            const toLocalDateString = (date) => {
                if (!date) return '';
                const d = new Date(date);
                const pad = n => String(n).padStart(2, '0');
                return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
            };

            useEffect(() => {
                if (event) {
                    setFormData({ title: event.title, description: event.description || '', zone: Array.isArray(event.zone) ? event.zone : [], type: event.type, recurrence: event.recurrence ? { ...event.recurrence } : null });
                    setStartDateTime(toLocalISOString(event.startDateTime));
                    setEndDateTime(toLocalISOString(event.endDateTime));
                    if (event.recurrence?.endDate) {
                        const ed = event.recurrence.endDate.toDate ? event.recurrence.endDate.toDate() : new Date(event.recurrence.endDate);
                        setFormData(prev => ({...prev, recurrence: {...prev.recurrence, endDate: toLocalDateString(ed)}}));
                    }
                } else {
                    const now = new Date(); now.setMinutes(0); now.setSeconds(0);
                    const end = new Date(now); end.setHours(now.getHours() + 1);
                    setStartDateTime(toLocalISOString(now)); setEndDateTime(toLocalISOString(end));
                }
            }, [event]);

            const handleSubmit = (e) => {
                e.preventDefault();
                const finalData = { ...formData, startDateTime: new Date(startDateTime), endDateTime: new Date(endDateTime) };
                if (formData.recurrence?.endDate) {
                    const [y,m,dd] = formData.recurrence.endDate.split('-').map(Number);
                    finalData.recurrence.endDate = new Date(y, m-1, dd);
                }
                onSave(finalData);
            };

            const handleZoneToggle = (zoneId) => {
                const newZones = new Set(formData.zone);
                if (newZones.has(zoneId)) newZones.delete(zoneId); else newZones.add(zoneId);
                setFormData({...formData, zone: Array.from(newZones)});
            };

            const isRecurring = !!formData.recurrence;

            return (
                <div className="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4 fade-in">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col" style={{maxHeight: '90vh'}}>
                        <div className="p-6 border-b flex justify-between items-center">
                            <h2 className="text-xl font-bold text-gray-900">{event ? 'Edit Event' : 'New Event'}</h2>
                            <button onClick={onClose}><Icons.X className="text-gray-400 hover:text-gray-600" /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-6 space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div className="col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Event Title</label>
                                    <input type="text" required value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="e.g., Aqua Fitness Class" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Start Time</label>
                                    <input type="datetime-local" required value={startDateTime} onChange={e => setStartDateTime(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">End Time {isRecurring && '(Daily)'}</label>
                                    <input type="datetime-local" required value={endDateTime} onChange={e => setEndDateTime(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                    <select value={formData.type} onChange={e => setFormData({...formData, type: e.target.value})} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                                        <option value="">Select Type</option>
                                        {Object.keys(settings?.eventTypes || {}).map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                </div>
                            </div>

                            <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" checked={isRecurring} onChange={e => setFormData(p => ({...p, recurrence: e.target.checked ? { frequency: 'weekly', days: [], endDate: '' } : null}))} className="w-5 h-5 text-blue-600 rounded" />
                                    <span className="font-semibold text-gray-700">Repeat Weekly</span>
                                </label>
                                {isRecurring && (
                                    <div className="mt-4 pl-7 space-y-4">
                                        <div>
                                            <span className="block text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Repeat On</span>
                                            <div className="flex flex-wrap gap-2">
                                                {['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'].map(day => (
                                                    <button type="button" key={day}
                                                        onClick={() => { const d = formData.recurrence.days || []; setFormData(p => ({...p, recurrence: {...p.recurrence, days: d.includes(day) ? d.filter(x=>x!==day) : [...d,day]}})); }}
                                                        className={`px-3 py-1 text-sm rounded-md transition-colors ${formData.recurrence.days.includes(day) ? 'bg-blue-600 text-white' : 'bg-white border border-gray-300 text-gray-700 hover:bg-gray-50'}`}>
                                                        {day.slice(0,3)}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Series Ends On</label>
                                            <input type="date" required value={formData.recurrence.endDate || ''} onChange={e => setFormData(p => ({...p, recurrence: {...p.recurrence, endDate: e.target.value}}))} className="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">Allocated Zones</label>
                                <div className="border border-gray-200 rounded-lg divide-y divide-gray-200 overflow-y-auto bg-gray-50" style={{maxHeight: '12rem'}}>
                                    {settings.zones.length > 0 ? settings.zones.map(zone => (
                                        <div key={zone.id} className="p-3">
                                            <label className="flex items-center gap-2 font-medium text-gray-900 cursor-pointer">
                                                <input type="checkbox" checked={formData.zone.includes(zone.id)} onChange={() => handleZoneToggle(zone.id)} className="rounded text-blue-600" />
                                                {zone.id}
                                            </label>
                                            {zone.children && zone.children.length > 0 && (
                                                <div className="ml-6 mt-2 grid grid-cols-2 md:grid-cols-3 gap-2">
                                                    {zone.children.map(child => (
                                                        <label key={child.id} className="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                                                            <input type="checkbox" checked={formData.zone.includes(child.id)} onChange={() => handleZoneToggle(child.id)} className="rounded text-blue-600" />
                                                            {child.id.replace(zone.id + ' - ', '')}
                                                        </label>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )) : <div className="p-4 text-center text-gray-500">No zones configured.</div>}
                                </div>
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                                <textarea value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" rows="3" placeholder="Additional details..."></textarea>
                            </div>
                        </form>
                        <div className="p-6 border-t bg-gray-50 flex justify-end gap-3 rounded-b-xl">
                            <button onClick={onClose} className="px-5 py-2 text-gray-700 font-medium hover:bg-gray-200 rounded-lg transition-colors">Cancel</button>
                            <button onClick={handleSubmit} className="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition-colors">Save Event</button>
                        </div>
                    </div>
                </div>
            );
        };

        // EXPORT MODAL (TIMETABLE HEATMAPS)
        const ExportModal = ({ settings, events, onClose }) => {
            const [weekOffset, setWeekOffset] = useState(0);
            const [printMode, setPrintMode] = useState('separate'); // 'separate' or 'consolidated'

            // Determine target week dates
            const { startOfWeek, endOfWeek, daysInWeek } = useMemo(() => {
                const now = new Date();
                now.setDate(now.getDate() + (weekOffset * 7));
                
                const currentDay = now.getDay() === 0 ? 7 : now.getDay();
                const start = new Date(now);
                start.setDate(now.getDate() - currentDay + 1);
                start.setHours(0,0,0,0);
                
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23,59,59,999);

                const days = [];
                for(let i=0; i<7; i++) {
                    const d = new Date(start);
                    d.setDate(start.getDate() + i);
                    days.push(d);
                }

                return { startOfWeek: start, endOfWeek: end, daysInWeek: days };
            }, [weekOffset]);

            // Expand events just for this specific week (With defensive capping)
            const weekEvents = useMemo(() => {
                const expanded = [];
                events.forEach(event => {
                    if (event.recurrence && event.recurrence.days) {
                        let current = new Date(event.startDateTime); 
                        current.setHours(0,0,0,0);
                        const endRecur = event.recurrence.endDate.toDate ? event.recurrence.endDate.toDate() : new Date(event.recurrence.endDate);
                        const effectiveEnd = new Date(Math.min(endRecur.getTime(), endOfWeek.getTime()));
                        
                        if (current < startOfWeek) current = new Date(startOfWeek);
                        const startTime = { h: event.startDateTime.getHours(), m: event.startDateTime.getMinutes() };
                        
                        // FIX 1: Cap recurring duration to the time-of-day difference to prevent daily blockouts
                        let duration = event.endDateTime.getTime() - event.startDateTime.getTime();
                        if (duration > 24 * 60 * 60 * 1000) {
                            const hDiff = event.endDateTime.getHours() - event.startDateTime.getHours();
                            const mDiff = event.endDateTime.getMinutes() - event.startDateTime.getMinutes();
                            duration = (hDiff * 60 + mDiff) * 60000;
                            if (duration < 0) duration += 24 * 60 * 60 * 1000;
                        }
                        
                        while(current <= effectiveEnd) {
                            const dayName = current.toLocaleDateString('en-US', { weekday: 'long' });
                            if (event.recurrence.days.includes(dayName)) {
                                const s = new Date(current); s.setHours(startTime.h, startTime.m, 0, 0);
                                expanded.push({ ...event, startDateTime: s, endDateTime: new Date(s.getTime() + duration) });
                            }
                            current.setDate(current.getDate() + 1);
                        }
                    } else {
                        // FIX 2: Clamp corrupted single-event entries (where end date was set months away by mistake)
                        if (event.endDateTime >= startOfWeek && event.startDateTime <= endOfWeek) {
                            const start = new Date(event.startDateTime);
                            let end = new Date(event.endDateTime);
                            const timeDiff = end.getTime() - start.getTime();
                            if (timeDiff > 24 * 60 * 60 * 1000) {
                                // Event is improperly logged as multiple days. Clamp it to same day.
                                end = new Date(start);
                                end.setHours(event.endDateTime.getHours(), event.endDateTime.getMinutes());
                                if (end < start) end.setDate(end.getDate() + 1);
                            }
                            expanded.push({ ...event, startDateTime: start, endDateTime: end });
                        }
                    }
                });
                return expanded;
            }, [events, startOfWeek, endOfWeek]);

            // FIX 3: Map ambiguously named lanes to their primary parent to prevent ghosting across multiple pools
            const childToParentMap = useMemo(() => {
                const map = {};
                settings.zones.forEach(z => {
                    z.children?.forEach(c => {
                        // First pool that defines this exact lane name "owns" it in ambiguous situations
                        if (!map[c.id]) map[c.id] = z.id;
                    });
                });
                return map;
            }, [settings.zones]);

            // Determine operational hours
            const displayHours = useMemo(() => {
                let minOpen = 6; 
                let maxClose = 19;
                if (settings.openingHours?.length > 0) {
                    minOpen = Math.min(...settings.openingHours.map(h => h.open));
                    maxClose = Math.max(...settings.openingHours.map(h => h.close));
                }
                const hrs = [];
                for(let i = minOpen; i < maxClose; i++) hrs.push(i);
                return hrs;
            }, [settings]);

            const printPage = () => window.print();

            return (
                <div className="fixed inset-0 bg-white z-50 overflow-auto fade-in print-modal-wrapper">
                    {/* Toolbar - Hidden when printing */}
                    <div className="print-hide sticky top-0 bg-gray-800 text-white p-4 flex flex-col md:flex-row justify-between items-center shadow-md z-10 gap-4">
                        <div className="flex flex-col sm:flex-row items-center gap-4">
                            <h2 className="text-xl font-bold whitespace-nowrap">Timetable Export</h2>
                            <div className="flex bg-gray-700 rounded-lg p-1">
                                <button onClick={() => setWeekOffset(o => o - 1)} className="px-3 py-1 hover:bg-gray-600 rounded text-sm transition-colors">&larr; Prev Week</button>
                                <div className="px-4 py-1 text-sm font-semibold border-l border-r border-gray-600 whitespace-nowrap">
                                    {startOfWeek.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' })} - {endOfWeek.toLocaleDateString('en-AU', { month: 'short', day: 'numeric' })}
                                </div>
                                <button onClick={() => setWeekOffset(o => o + 1)} className="px-3 py-1 hover:bg-gray-600 rounded text-sm transition-colors">Next Week &rarr;</button>
                                <button onClick={() => setWeekOffset(0)} className="px-3 py-1 ml-2 bg-blue-600 hover:bg-blue-500 rounded text-sm transition-colors hidden sm:block">Current</button>
                            </div>
                            <div className="flex bg-gray-700 rounded-lg p-1">
                                <button onClick={() => setPrintMode('separate')} className={`px-3 py-1 text-sm rounded transition-colors ${printMode === 'separate' ? 'bg-blue-600 text-white shadow' : 'text-gray-300 hover:text-white'}`}>Separate Pages</button>
                                <button onClick={() => setPrintMode('consolidated')} className={`px-3 py-1 text-sm rounded transition-colors ${printMode === 'consolidated' ? 'bg-blue-600 text-white shadow' : 'text-gray-300 hover:text-white'}`}>Consolidated</button>
                            </div>
                        </div>
                        <div className="flex gap-3 w-full md:w-auto justify-end">
                            <button onClick={printPage} className="flex items-center gap-2 bg-white text-gray-900 px-4 py-2 rounded-lg font-bold hover:bg-gray-100 transition-colors"><Icons.Printer size={18} /> Print Timetable</button>
                            <button onClick={onClose} className="p-2 text-gray-300 hover:text-white transition-colors"><Icons.X size={24} /></button>
                        </div>
                    </div>

                    {/* Print Document Area */}
                    <div className="p-4 sm:p-8 max-w-6xl mx-auto space-y-8">
                        {settings.zones.map((zone, idx) => (
                            <div key={zone.id} className={`${printMode === 'separate' ? 'print-page-break mb-12' : 'mb-6 print-break-inside-avoid'}`}>
                                <div className="mb-3 flex justify-between items-end border-b-2 border-blue-900 pb-2">
                                    <div>
                                        <h1 className={`${printMode === 'consolidated' ? 'text-xl' : 'text-3xl'} font-extrabold text-blue-900 tracking-tight`}>Clarence Regional Aquatic Centre</h1>
                                        <h2 className={`${printMode === 'consolidated' ? 'text-lg' : 'text-2xl'} font-bold text-gray-700 mt-1`}>{zone.id} Availability</h2>
                                        <p className={`text-gray-500 font-medium ${printMode === 'consolidated' ? 'text-xs' : 'text-base'}`}>Week of {startOfWeek.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</p>
                                    </div>
                                    <div className={`text-right ${printMode === 'consolidated' ? 'text-xs' : 'text-sm'}`}>
                                        <div className="flex items-center gap-4 mt-2">
                                            <div className="flex items-center gap-1"><span className="w-4 h-4 rounded bg-green-50 border border-green-200 block"></span> Free</div>
                                            <div className="flex items-center gap-1"><span className="w-4 h-4 rounded bg-yellow-100 border border-yellow-300 block"></span> Partial</div>
                                            <div className="flex items-center gap-1"><span className="w-4 h-4 rounded bg-red-100 border border-red-300 block"></span> Booked</div>
                                        </div>
                                    </div>
                                </div>

                                <div className="border border-gray-300 rounded-lg print:overflow-visible overflow-hidden print-break-inside-avoid">
                                    <table className="w-full text-sm text-left border-collapse bg-white">
                                        <thead className="bg-gray-100 text-gray-700 uppercase font-bold text-xs border-b border-gray-300">
                                            <tr>
                                                <th className={`px-2 py-2 border-r border-gray-300 w-20 sm:w-24 text-center bg-gray-200 ${printMode === 'consolidated' ? 'text-10' : ''}`}>Time</th>
                                                {daysInWeek.map(day => (
                                                    <th key={day.toISOString()} className="px-2 py-2 border-r border-gray-300 text-center w-[12%]">
                                                        <div className={`font-extrabold ${printMode === 'consolidated' ? 'text-10' : ''}`}>{day.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                                                        <div className={`font-normal text-gray-500 ${printMode === 'consolidated' ? 'text-10' : ''}`}>{day.toLocaleDateString('en-US', { day: 'numeric', month: 'short' })}</div>
                                                    </th>
                                                ))}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {displayHours.map(hour => (
                                                <tr key={hour} className="border-b border-gray-200">
                                                    <td className={`px-1 py-2 border-r border-gray-300 font-bold text-gray-600 text-center bg-gray-50 align-top ${printMode === 'consolidated' ? 'text-10' : 'text-xs sm:text-sm'}`}>
                                                        {hour === 12 ? '12 PM' : hour > 12 ? `${hour-12} PM` : `${hour} AM`}
                                                    </td>
                                                    {daysInWeek.map(day => {
                                                        const cellStart = new Date(day); cellStart.setHours(hour, 0, 0, 0);
                                                        const cellEnd = new Date(day); cellEnd.setHours(hour + 1, 0, 0, 0);
                                                        
                                                        // Accurate Zone Filter matching utilizing ghost-pool protection
                                                        const cellEvents = weekEvents.filter(e => {
                                                            const overlapsTime = e.startDateTime < cellEnd && e.endDateTime > cellStart;
                                                            if(!overlapsTime) return false;
                                                            
                                                            const eZones = Array.isArray(e.zone) ? e.zone : [e.zone];
                                                            
                                                            // Explicit parent zone match
                                                            if (eZones.includes(zone.id)) return true;
                                                            
                                                            // Detailed child lane match (protects against identical lane names across different pools)
                                                            if (zone.children && zone.children.length > 0) {
                                                                return eZones.some(z => {
                                                                    if (z.startsWith(zone.id + ' - ')) return true;
                                                                    if (zone.children.some(c => c.id === z)) {
                                                                        if (eZones.includes(zone.id)) return true; // Parent uniquely checked alongside child
                                                                        if (childToParentMap[z] === zone.id) return true; // Unique child resolution map checks primary ownership
                                                                    }
                                                                    return false;
                                                                });
                                                            }
                                                            return false;
                                                        });

                                                        let isFullyBooked = false;
                                                        let bookedLanes = new Set();
                                                        let mainEventTitle = "";

                                                        cellEvents.forEach(e => {
                                                            const eZones = Array.isArray(e.zone) ? e.zone : [e.zone];
                                                            if (eZones.includes(zone.id)) {
                                                                isFullyBooked = true;
                                                                if(!mainEventTitle) mainEventTitle = e.title;
                                                            } else {
                                                                eZones.forEach(z => {
                                                                    if(zone.children?.some(c => c.id === z || z === `${zone.id} - ${c.id}`)) {
                                                                        bookedLanes.add(z);
                                                                    }
                                                                });
                                                            }
                                                        });

                                                        const totalChildren = zone.children?.length || 0;
                                                        if (totalChildren > 0 && bookedLanes.size >= totalChildren) {
                                                            isFullyBooked = true;
                                                        }

                                                        let bgClass = "bg-green-50";
                                                        let borderClass = "border-green-200";
                                                        let textContent = <span className="text-green-700 font-medium">Free</span>;

                                                        if (isFullyBooked) {
                                                            bgClass = "bg-red-100";
                                                            borderClass = "border-red-300";
                                                            textContent = (
                                                                <div className="flex flex-col items-center justify-center text-center">
                                                                    <span className="text-red-800 font-bold leading-tight">{mainEventTitle || 'Fully Booked'}</span>
                                                                </div>
                                                            );
                                                        } else if (totalChildren > 0 && bookedLanes.size > 0) {
                                                            bgClass = "bg-yellow-100";
                                                            borderClass = "border-yellow-300";
                                                            textContent = (
                                                                <div className="flex flex-col items-center justify-center text-center">
                                                                    <span className="text-yellow-800 font-bold">{totalChildren - bookedLanes.size} Lanes</span>
                                                                    <span className="text-yellow-700 text-xs mt-0.5">Available</span>
                                                                </div>
                                                            );
                                                        } else if (cellEvents.length > 0) {
                                                            // Fallback safety for non-lane pools
                                                            bgClass = "bg-yellow-100";
                                                            borderClass = "border-yellow-300";
                                                            textContent = (
                                                                <div className="flex flex-col items-center justify-center text-center">
                                                                    <span className="text-yellow-800 font-bold leading-tight">{cellEvents[0].title}</span>
                                                                </div>
                                                            );
                                                        }

                                                        return (
                                                            <td key={day.toISOString()} className={`p-[2px] sm:p-1 border-r border-gray-300 ${bgClass} transition-colors`}>
                                                                <div 
                                                                    className={`print-cell-wrapper h-full flex flex-col items-center justify-center p-1 rounded border ${borderClass} bg-opacity-50 print-text-sm ${printMode === 'consolidated' ? 'text-10 leading-tight' : 'text-xs'}`}
                                                                    style={{ minHeight: printMode === 'consolidated' ? '2.5rem' : '4rem' }}
                                                                >
                                                                    {textContent}
                                                                </div>
                                                            </td>
                                                        );
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                <div className={`mt-3 text-center text-gray-500 font-medium ${printMode === 'consolidated' ? 'text-xs pb-4 border-b border-gray-200' : 'text-sm pb-8 border-b border-gray-200'}`}>
                                    Achieve your fitness goals! Join us at the Clarence Regional Aquatic Centre.
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // SETTINGS MODAL
        const SettingsModal = ({ settings, events, onSave, onDeleteBatch, onClose }) => {
            const [localSettings, setLocalSettings] = useState(JSON.parse(JSON.stringify(settings)));
            const [activeTab, setActiveTab] = useState('zones');
            const handleSave = () => { onSave(localSettings); onClose(); };

            const Tabs = {
                zones: <ZoneSettings settings={localSettings} setSettings={setLocalSettings} />,
                eventTypes: <EventTypeSettings settings={localSettings} setSettings={setLocalSettings} />,
                hours: <HoursSettings settings={localSettings} setSettings={setLocalSettings} />,
                maintenance: <MaintenanceSettings events={events} onDeleteBatch={onDeleteBatch} />
            };

            return (
                <div className="fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4 fade-in print-hide">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl flex flex-col" style={{height: '90vh'}}>
                        <div className="p-6 border-b flex justify-between items-center flex-shrink-0">
                            <h2 className="text-xl font-bold text-gray-900">System Configuration</h2>
                            <button onClick={onClose}><Icons.X className="text-gray-400 hover:text-gray-600" /></button>
                        </div>
                        <div className="flex flex-1 overflow-hidden">
                            <aside className="bg-gray-50 border-r p-4 space-y-1 flex-shrink-0" style={{width: '16rem'}}>
                                {['zones','eventTypes','hours','maintenance'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)}
                                        className={`w-full text-left px-4 py-3 rounded-lg text-sm font-medium transition-colors ${activeTab === tab ? 'bg-white text-blue-600 shadow-sm border border-gray-200' : 'text-gray-600 hover:bg-gray-100'}`}>
                                        {tab === 'zones' ? 'Zone Management' : tab === 'eventTypes' ? 'Event Types' : tab === 'maintenance' ? 'Maintenance' : 'Opening Hours'}
                                    </button>
                                ))}
                            </aside>
                            <main className="flex-1 overflow-y-auto p-6">{Tabs[activeTab]}</main>
                        </div>
                        <div className="p-6 border-t flex justify-end gap-3 flex-shrink-0">
                            <button onClick={onClose} className="px-5 py-2 text-gray-700 font-medium hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
                            <button onClick={handleSave} className="px-5 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-md transition-colors">Save Configuration</button>
                        </div>
                    </div>
                </div>
            );
        };

        const MaintenanceSettings = ({ events, onDeleteBatch }) => {
            const [pastEvents, setPastEvents] = useState([]);
            const [scanned, setScanned] = useState(false);
            const [isDeleting, setIsDeleting] = useState(false);

            useEffect(() => {
                if (scanned) {
                    const now = new Date();
                    const past = events.filter(e => {
                        if (e.recurrence && e.recurrence.endDate) {
                            const end = e.recurrence.endDate.toDate ? e.recurrence.endDate.toDate() : new Date(e.recurrence.endDate);
                            const cutoff = new Date(end); cutoff.setHours(23, 59, 59, 999);
                            return now > cutoff;
                        }
                        if (!e.endDateTime) return false;
                        const endDt = e.endDateTime.toDate ? e.endDateTime.toDate() : new Date(e.endDateTime);
                        return endDt < now;
                    });
                    setPastEvents(past);
                }
            }, [events, scanned]);

            const handleDeleteClick = async () => {
                if (pastEvents.length === 0) return;
                setIsDeleting(true);
                await onDeleteBatch(pastEvents.map(e => e.id));
                setIsDeleting(false);
            };

            return (
                <div className="space-y-6">
                    <div>
                        <h3 className="text-lg font-bold text-gray-900 mb-2">Data Cleanup</h3>
                        <p className="text-sm text-gray-500 mb-4">Identify and remove events that have already finished to keep your calendar running smoothly.</p>
                        {!scanned ? (
                            <button onClick={() => setScanned(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 flex items-center gap-2">
                                <Icons.Search size={18} /> Scan for Past Events
                            </button>
                        ) : (
                            <div>
                                <div className="flex justify-between items-center mb-4">
                                    <h4 className="font-semibold text-gray-800">{pastEvents.length} Past Events Found</h4>
                                    <button onClick={() => setScanned(false)} className="text-sm text-blue-600 hover:underline">Rescan</button>
                                </div>
                                {pastEvents.length > 0 ? (
                                    <div className="space-y-4">
                                        <div className="bg-gray-50 border rounded-lg p-3 overflow-y-auto text-sm space-y-2" style={{maxHeight: '15rem'}}>
                                            {pastEvents.map(e => (
                                                <div key={e.id} className="flex justify-between border-b border-gray-200 pb-2" style={{borderBottom: pastEvents[pastEvents.length-1].id === e.id ? 'none' : ''}}>
                                                    <span className="font-medium text-gray-700">{e.title}</span>
                                                    <span className="text-gray-500 text-xs">
                                                        {e.recurrence
                                                            ? `Ended: ${new Date(e.recurrence.endDate.toDate ? e.recurrence.endDate.toDate() : e.recurrence.endDate).toLocaleDateString()}`
                                                            : `Ended: ${e.endDateTime.toLocaleDateString()}`}
                                                    </span>
                                                </div>
                                            ))}
                                        </div>
                                        <button onClick={handleDeleteClick} disabled={isDeleting}
                                            style={{opacity: isDeleting ? 0.6 : 1}}
                                            className="w-full bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 flex items-center justify-center gap-2 transition-colors">
                                            {isDeleting ? <div className="animate-spin rounded-full h-4 w-4 border-2 border-white" style={{borderTopColor: 'transparent'}}></div> : <Icons.Trash size={18} />}
                                            {isDeleting ? 'Deleting...' : `Delete ${pastEvents.length} Events`}
                                        </button>
                                    </div>
                                ) : (
                                    <div className="p-4 bg-green-50 text-green-700 rounded-lg border border-green-200 flex items-center gap-2">
                                        <Icons.Check size={20} /> Your database is clean! No past events found.
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const ZoneSettings = ({ settings, setSettings }) => {
            const [newZone, setNewZone] = useState('');
            const [editingId, setEditingId] = useState(null);
            const [tempName, setTempName] = useState('');
            const [newChildNames, setNewChildNames] = useState({});

            const add = () => { if(!newZone.trim()) return; setSettings(s => ({...s, zones: [...s.zones, {id: newZone.trim(), children: []}]})); setNewZone(''); };
            const remove = (id) => { setSettings(s => ({...s, zones: s.zones.filter(z => z.id !== id)})); };
            const startEdit = (id) => { setEditingId(id); setTempName(id); };
            const saveEdit = (oldId) => {
                if (!tempName.trim()) return;
                setSettings(s => ({...s, zones: s.zones.map(z => z.id === oldId ? {...z, id: tempName.trim()} : z)}));
                setEditingId(null);
            };
            const addChild = (parentId) => {
                const childName = (newChildNames[parentId] || '').trim();
                if (!childName) return;
                setSettings(s => ({...s, zones: s.zones.map(z => z.id === parentId ? {...z, children: [...(z.children||[]), {id: childName}]} : z)}));
                setNewChildNames({...newChildNames, [parentId]: ''});
            };
            const removeChild = (parentId, childId) => {
                setSettings(s => ({...s, zones: s.zones.map(z => z.id === parentId ? {...z, children: z.children.filter(c => c.id !== childId)} : z)}));
            };

            return (
                <div className="space-y-6">
                    <div>
                        <h3 className="text-lg font-bold text-gray-900 mb-4">Facility Zones</h3>
                        <p className="text-sm text-gray-500 mb-4">Manage major areas and their sub-lanes.</p>
                        <div className="space-y-3">
                            {settings.zones.map(z => (
                                <div key={z.id} className="bg-white border rounded-lg shadow-sm overflow-hidden">
                                    <div className="flex items-center justify-between p-3 bg-gray-50 border-b">
                                        {editingId === z.id ? (
                                            <div className="flex gap-2 flex-1 mr-4">
                                                <input value={tempName} onChange={e => setTempName(e.target.value)} className="flex-1 p-1 border rounded" />
                                                <button onClick={() => saveEdit(z.id)} className="text-green-600"><Icons.Check size={18} /></button>
                                                <button onClick={() => setEditingId(null)} className="text-gray-500"><Icons.X size={18} /></button>
                                            </div>
                                        ) : (
                                            <div className="flex items-center gap-3">
                                                <span className="font-bold text-gray-800">{z.id}</span>
                                                <button onClick={() => startEdit(z.id)} className="text-gray-400 hover:text-blue-600"><Icons.Edit size={14} /></button>
                                            </div>
                                        )}
                                        <button onClick={() => remove(z.id)} className="text-red-500 text-sm hover:underline">Delete Zone</button>
                                    </div>
                                    <div className="p-3">
                                        <div className="space-y-2 mb-3">
                                            {z.children && z.children.map(child => (
                                                <div key={child.id} className="flex justify-between items-center text-sm p-2 bg-gray-50 rounded border border-gray-100">
                                                    <span>{child.id}</span>
                                                    <button onClick={() => removeChild(z.id, child.id)} className="text-red-400 hover:text-red-600"><Icons.Trash size={14} /></button>
                                                </div>
                                            ))}
                                            {(!z.children || z.children.length === 0) && <p className="text-xs text-gray-400 italic">No sub-zones configured.</p>}
                                        </div>
                                        <div className="flex gap-2">
                                            <input value={newChildNames[z.id] || ''} onChange={e => setNewChildNames({...newChildNames, [z.id]: e.target.value})} className="flex-1 p-1 text-sm border rounded" placeholder="New Lane Name (e.g. Lane 1)" />
                                            <button onClick={() => addChild(z.id)} className="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm font-medium hover:bg-blue-200">Add Lane</button>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    <div className="flex gap-3 pt-4 border-t">
                        <input value={newZone} onChange={e => setNewZone(e.target.value)} className="flex-1 p-2 border rounded-lg" placeholder="New Parent Zone (e.g. 50m Pool)" />
                        <button onClick={add} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add Zone</button>
                    </div>
                </div>
            );
        };

        const EventTypeSettings = ({ settings, setSettings }) => {
            const [newName, setNewName] = useState('');
            const [newColor, setNewColor] = useState('#3B82F6');
            const [editingKey, setEditingKey] = useState(null);
            const [editName, setEditName] = useState('');

            const add = () => { if(!newName.trim()) return; setSettings(s => ({...s, eventTypes: {...s.eventTypes, [newName.trim()]: newColor}})); setNewName(''); };
            const remove = (key) => { const n = {...settings.eventTypes}; delete n[key]; setSettings(s => ({...s, eventTypes: n})); };
            const updateColor = (key, color) => { setSettings(s => ({...s, eventTypes: {...s.eventTypes, [key]: color}})); };
            const startRename = (key) => { setEditingKey(key); setEditName(key); };
            const saveRename = (oldKey) => {
                if (!editName.trim()) return;
                const newTypes = {};
                Object.keys(settings.eventTypes).forEach(k => { newTypes[k === oldKey ? editName.trim() : k] = settings.eventTypes[k]; });
                setSettings(s => ({...s, eventTypes: newTypes}));
                setEditingKey(null);
            };

            return (
                <div>
                    <h3 className="text-lg font-bold text-gray-900 mb-4">Event Types</h3>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-6">
                        {Object.entries(settings.eventTypes).map(([key, val]) => (
                            <div key={key} className="flex items-center gap-3 p-3 bg-white border rounded-lg shadow-sm">
                                <input type="color" value={val} onChange={e => updateColor(key, e.target.value)} className="w-8 h-8 rounded cursor-pointer border-0 p-0" title="Change Color" />
                                {editingKey === key ? (
                                    <div className="flex gap-2 flex-1">
                                        <input value={editName} onChange={e => setEditName(e.target.value)} className="w-full text-sm border rounded px-1" />
                                        <button onClick={() => saveRename(key)} className="text-green-600"><Icons.Check size={16} /></button>
                                        <button onClick={() => setEditingKey(null)} className="text-gray-400"><Icons.X size={16} /></button>
                                    </div>
                                ) : (
                                    <div className="flex-1 flex items-center gap-2">
                                        <span className="font-medium">{key}</span>
                                        <button onClick={() => startRename(key)} className="text-gray-300 hover:text-blue-600"><Icons.Edit size={12} /></button>
                                    </div>
                                )}
                                <button onClick={() => remove(key)} className="text-red-400 hover:text-red-600"><Icons.Trash size={16} /></button>
                            </div>
                        ))}
                    </div>
                    <div className="flex gap-3 items-center bg-gray-50 p-4 rounded-lg">
                        <input value={newName} onChange={e => setNewName(e.target.value)} placeholder="New Type Name" className="flex-1 p-2 border rounded-lg" />
                        <input type="color" value={newColor} onChange={e => setNewColor(e.target.value)} className="h-10 w-14 rounded cursor-pointer border-0" />
                        <button onClick={add} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700">Add</button>
                    </div>
                </div>
            );
        };

        const HoursSettings = ({ settings, setSettings }) => {
            const updateHour = (day, field, val) => {
                setSettings(s => ({...s, openingHours: s.openingHours.map(h => h.day === day ? {...h, [field]: parseInt(val)} : h)}));
            };
            return (
                <div>
                    <h3 className="text-lg font-bold text-gray-900 mb-4">Opening Hours</h3>
                    <div className="space-y-2">
                        {settings.openingHours?.length > 0 ? settings.openingHours.map(h => (
                            <div key={h.day} className="flex items-center justify-between p-3 bg-white border rounded-lg">
                                <span className="font-medium" style={{width: '8rem'}}>{h.day}</span>
                                <div className="flex items-center gap-4">
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-gray-500 uppercase">Open</span>
                                        <select value={h.open} onChange={e => updateHour(h.day, 'open', e.target.value)} className="border rounded p-1 text-sm">
                                            {Array.from({length: 24}, (_, i) => <option key={i} value={i}>{i}:00</option>)}
                                        </select>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs text-gray-500 uppercase">Close</span>
                                        <select value={h.close} onChange={e => updateHour(h.day, 'close', e.target.value)} className="border rounded p-1 text-sm">
                                            {Array.from({length: 24}, (_, i) => <option key={i} value={i}>{i}:00</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        )) : <div className="text-gray-500 italic">No opening hours configured.</div>}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
