<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAC Zone Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%23007bff' d='M0 50 Q 25 25, 50 50 T 100 50 V 100 H 0 Z' /></svg>">
    <style>
        body { font-family: sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAF44-oMKqTKPcMgOuKfJJqUTJz9JYTHAg",
          authDomain: "osf---availability-roster.firebaseapp.com",
          projectId: "osf---availability-roster",
          storageBucket: "osf---availability-roster.firebasestorage.app",
          messagingSenderId: "1069751236100",
          appId: "1:1069751236100:web:6a2c9a1570f99927e86751",
          measurementId: "G-JT3PMQ0W6T"
        };
        
        const OPENING_HOURS = [
            { day: 'Sunday', open: 8, close: 18 },    // 8am - 6pm
            { day: 'Monday', open: 6, close: 20 },    // 6am - 8pm
            { day: 'Tuesday', open: 6, close: 20 },
            { day: 'Wednesday', open: 6, close: 20 },
            { day: 'Thursday', open: 6, close: 20 },
            { day: 'Friday', open: 6, close: 20 },
            { day: 'Saturday', open: 7, close: 19 }  // 7am - 7pm
        ];

        const ZONES_CONFIG = [
            { id: '50m Olympic Pool', name: '50m Olympic Pool', children: [
                { id: '50m Olympic Pool - Lane 1', name: 'Lane 1' },
                { id: '50m Olympic Pool - Lane 2', name: 'Lane 2' },
                { id: '50m Olympic Pool - Lane 3', name: 'Lane 3' },
                { id: '50m Olympic Pool - Lane 4', name: 'Lane 4' },
                { id: '50m Olympic Pool - Lane 5', name: 'Lane 5' },
                { id: '50m Olympic Pool - Lane 6', name: 'Lane 6' },
                { id: '50m Olympic Pool - Lane 7', name: 'Lane 7' },
                { id: '50m Olympic Pool - Lane 8', name: 'Lane 8' },
            ]},
            { id: 'Program Pool', name: 'Program Pool', children: [
                { id: 'Program Pool - Zone 1', name: 'Zone 1' },
                { id: 'Program Pool - Zone 2', name: 'Zone 2' },
                { id: 'Program Pool - Zone 3', name: 'Zone 3' },
            ]},
            { id: '25m Lap Pool', name: '25m Lap Pool', children: [
                { id: '25m Lap Pool - Lane 1', name: 'Lane 1' },
                { id: '25m Lap Pool - Lane 2', name: 'Lane 2' },
                { id: '25m Lap Pool - Lane 3', name: 'Lane 3' },
                { id: '25m Lap Pool - Lane 4', name: 'Lane 4' },
                { id: '25m Lap Pool - Lane 5', name: 'Lane 5' },
                { id: '25m Lap Pool - Lane 6', name: 'Lane 6' },
                { id: '25m Lap Pool - Lane 7', name: 'Lane 7' },
                { id: '25m Lap Pool - Lane 8', name: 'Lane 8' },
            ]},
            { id: 'Splash Pad', name: 'Splash Pad' },
            { id: 'Club Room', name: 'Club Room' },
        ];
        
        const getFlatZonesWithAll = () => {
            const zones = ['All Zones'];
            ZONES_CONFIG.forEach(zone => {
                zones.push(zone.id);
                if (zone.children) {
                    zone.children.forEach(child => zones.push(child.id));
                }
            });
            return zones;
        };
        const ALL_ZONES_FLAT = getFlatZonesWithAll();
        
        const EVENT_TYPES = { 'Class': 'bg-blue-600', 'Booking': 'bg-green-600', 'Closure': 'bg-red-600', 'Event': 'bg-purple-600', 'Maintenance': 'bg-yellow-600' };
        // ---------------------

        const { useState, useEffect, useMemo } = React;
        let db;
        try {
            if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch(e) { console.error("Firebase init failed", e); }

        const App = () => {
            const [events, setEvents] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [zoneFilter, setZoneFilter] = useState('All Zones');
            const [view, setView] = useState('month');

            useEffect(() => {
                if (!db) { setError("Calendar could not be loaded."); setIsLoading(false); return; }
                const unsubscribe = db.collection('calendar_events').onSnapshot(snapshot => {
                    const fetchedEvents = snapshot.docs.map(doc => {
                        const data = doc.data();
                        const zones = Array.isArray(data.zone) ? data.zone : (data.zone ? [data.zone] : []);
                        return { id: doc.id, ...data, zone: zones, startDateTime: data.startDateTime.toDate(), endDateTime: data.endDateTime.toDate() };
                    });
                    setEvents(fetchedEvents);
                    setIsLoading(false);
                }, err => { setError(`Failed to load events: ${err.message}`); setIsLoading(false); });
                return () => unsubscribe();
            }, []);

            const filteredEvents = useMemo(() => {
                if (zoneFilter === 'All Zones') return events;
                const parentZone = ZONES_CONFIG.find(z => z.id === zoneFilter);
                const childZoneIds = parentZone?.children?.map(c => c.id) || [];
                return events.filter(e => e.zone && e.zone.some(z => z === zoneFilter || childZoneIds.includes(z)));
            }, [events, zoneFilter]);

            const eventsByDate = useMemo(() => filteredEvents.reduce((acc, event) => { const key = event.startDateTime.toDateString(); if (!acc[key]) acc[key] = []; acc[key].push(event); return acc; }, {}), [filteredEvents]);

            const changeDate = (offset) => { setCurrentDate(prev => { const d = new Date(prev); const unit = view === 'month' ? 'Month' : 'Date'; d[`set${unit}`](prev[`get${unit}`]() + offset); return d; }); };

            return (
                <div className="container mx-auto p-4 max-w-5xl">
                    <Header currentDate={currentDate} changeDate={changeDate} zoneFilter={zoneFilter} setZoneFilter={setZoneFilter} view={view} setView={setView} />
                    {isLoading && <p>Loading calendar...</p>}
                    {error && <p className="text-red-600">{error}</p>}
                    {!isLoading && !error && (
                        <div className="bg-white border border-gray-200 rounded-lg overflow-hidden">
                        {
                            view === 'month' ?
                            <CalendarGrid currentDate={currentDate} eventsByDate={eventsByDate} onEventClick={setSelectedEvent} onDayClick={(day) => { setCurrentDate(day); setView('day');}}/> :
                            <DayView currentDate={currentDate} events={eventsByDate[currentDate.toDateString()] || []} onEventClick={setSelectedEvent} />
                        }
                        </div>
                    )}
                    {selectedEvent && <EventModal event={selectedEvent} onClose={() => setSelectedEvent(null)} />}
                </div>
            );
        };
        
        const Header = ({ currentDate, changeDate, zoneFilter, setZoneFilter, view, setView }) => (
            <div className="flex flex-col md:flex-row justify-between items-center mb-6">
                 <div className="flex items-center space-x-4">
                    <div className="flex items-center space-x-2">
                        <button onClick={() => changeDate(-1)} className="p-2 rounded-md hover:bg-gray-200">‹</button>
                        <h2 className="text-2xl font-bold w-48 text-center">{view === 'day' ? currentDate.toLocaleDateString('default', {weekday: 'long', day: 'numeric', month: 'long'}) : currentDate.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                        <button onClick={() => changeDate(1)} className="p-2 rounded-md hover:bg-gray-200">›</button>
                    </div>
                    <div className="bg-gray-200 p-1 rounded-md">
                        <button onClick={() => setView('month')} className={`px-3 py-1 text-sm rounded ${view === 'month' ? 'bg-white shadow' : ''}`}>Month</button>
                        <button onClick={() => setView('day')} className={`px-3 py-1 text-sm rounded ${view === 'day' ? 'bg-white shadow' : ''}`}>Day</button>
                    </div>
                </div>
                <div className="mt-4 md:mt-0">
                    <label htmlFor="zoneFilter" className="sr-only">Filter by Zone</label>
                    <select id="zoneFilter" value={zoneFilter} onChange={e => setZoneFilter(e.target.value)} className="rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        {ALL_ZONES_FLAT.map(zone => <option key={zone} value={zone}>{zone}</option>)}
                    </select>
                </div>
            </div>
        );

        const CalendarGrid = ({ currentDate, eventsByDate, onEventClick, onDayClick }) => {
            const startDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const endDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(startDay); startDate.setDate(startDate.getDate() - startDay.getDay());
            const endDate = new Date(endDay); endDate.setDate(endDate.getDate() + (6 - endDay.getDay()));
            const days = []; let day = new Date(startDate); while (day <= endDate) { days.push(new Date(day)); day.setDate(day.getDate() + 1); }
            return (
                <div className="grid grid-cols-7 border-t border-l border-gray-200">
                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => <div key={d} className="text-center font-bold p-2 border-b border-gray-200 bg-gray-50 text-sm">{d}</div>)}
                    {days.map(d => <CalendarDay key={d.toISOString()} day={d} isCurrentMonth={d.getMonth() === currentDate.getMonth()} events={eventsByDate[d.toDateString()] || []} onEventClick={onEventClick} onDayClick={onDayClick} />)}
                </div>
            );
        };

        const CalendarDay = ({ day, isCurrentMonth, events, onEventClick, onDayClick }) => (
            <div className={`border-r border-b border-gray-200 p-2 min-h-[120px] ${isCurrentMonth ? 'bg-white' : 'bg-gray-50'} cursor-pointer hover:bg-blue-50 transition-colors`} onClick={() => onDayClick(day)}>
                <time className={`text-sm ${new Date().toDateString() === day.toDateString() ? 'font-bold text-blue-600' : isCurrentMonth ? 'text-gray-700' : 'text-gray-400'}`}>{day.getDate()}</time>
                <div className="mt-1 space-y-1">
                    {events.sort((a,b) => a.startDateTime - b.startDateTime).map(event => <EventChip key={event.id} event={event} onClick={(e) => { e.stopPropagation(); onEventClick(event);}} />)}
                </div>
            </div>
        );

        const DayView = ({ currentDate, events, onEventClick }) => {
            const dayOfWeek = currentDate.getDay();
            const operatingHours = OPENING_HOURS[dayOfWeek];
            const startHour = operatingHours.open;
            const endHour = operatingHours.close;

            const hours = Array.from({ length: endHour - startHour }, (_, i) => startHour + i);
            const sortedEvents = events.sort((a, b) => a.startDateTime - b.startDateTime);
            const PIXELS_PER_MINUTE = 1.5;

            return (
                 <div className="flex">
                    <div className="w-20 shrink-0">
                         {hours.map(hour => (
                            <div key={hour} className="h-[90px] border-r border-b border-gray-200 text-right pr-2 pt-1 relative">
                                <span className="text-sm text-gray-500">{hour > 12 ? hour - 12 : hour === 0 ? 12 : hour}{hour >= 12 ? 'pm' : 'am'}</span>
                            </div>
                        ))}
                    </div>
                    <div className="flex-grow relative">
                         {hours.map(hour => (<div key={hour} className="h-[90px] border-b border-gray-200"></div>))}
                         {sortedEvents.map(event => {
                             const top = ((event.startDateTime.getHours() - startHour) * 60 + event.startDateTime.getMinutes()) * PIXELS_PER_MINUTE;
                             const duration = (event.endDateTime - event.startDateTime) / (1000 * 60);
                             const height = Math.max(24, duration * PIXELS_PER_MINUTE);

                             if (event.endDateTime.getHours() < startHour || event.startDateTime.getHours() > endHour) {
                                 return null;
                             }

                             return (
                                 <div key={event.id}
                                     className={`absolute w-[calc(100%-1rem)] left-2 rounded-lg p-2 text-white text-xs flex flex-col overflow-hidden cursor-pointer ${EVENT_TYPES[event.type] || 'bg-gray-400'}`}
                                     style={{ top: `${top}px`, height: `${height}px` }}
                                     onClick={() => onEventClick(event)}
                                 >
                                    <p className="font-bold truncate">{event.title}</p>
                                    <p className="truncate">{event.startDateTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - {event.endDateTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                 </div>
                             );
                         })}
                    </div>
                 </div>
            );
        };

        const EventChip = ({ event, onClick }) => {
            const time = event.startDateTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', hour12: false});
            return (
                <button onClick={onClick} className={`w-full text-left text-xs p-1 rounded text-white truncate ${EVENT_TYPES[event.type] || 'bg-gray-400'}`}>
                    <span className="font-bold">{time}</span> {event.title}
                </button>
            );
        };
        
        const EventModal = ({ event, onClose }) => {
             const formatTime = (date) => date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg" onClick={e => e.stopPropagation()}>
                         <div className="flex justify-between items-start mb-4">
                            <div>
                                <h3 className="text-xl font-bold">{event.title}</h3>
                                <p className="text-sm text-gray-500">{new Date(event.startDateTime).toLocaleDateString([], {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</p>
                            </div>
                             <span className={`px-3 py-1 text-sm font-bold rounded-full text-white ${EVENT_TYPES[event.type] || 'bg-gray-500'}`}>{event.type}</span>
                         </div>
                         <div className="space-y-2 text-gray-700">
                             <p><strong>Time:</strong> {formatTime(event.startDateTime)} - {formatTime(event.endDateTime)}</p>
                             <p><strong>Zone(s):</strong> {Array.isArray(event.zone) ? event.zone.join(', ') : event.zone}</p>
                             {event.description && <p className="pt-2 whitespace-pre-wrap">{event.description}</p>}
                         </div>
                         <div className="text-right mt-6">
                             <button onClick={onClose} className="py-2 px-4 rounded-md bg-gray-200 hover:bg-gray-300">Close</button>
                         </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>


