<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRAC Zone Availability</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path fill='%23007bff' d='M0 50 Q 25 25, 50 50 T 100 50 V 100 H 0 Z' /></svg>">
    <style> body { font-family: 'Inter', sans-serif; } </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyAF44-oMKqTKPcMgOuKfJJqUTJz9JYTHAg",
          authDomain: "osf---availability-roster.firebaseapp.com",
          projectId: "osf---availability-roster",
          storageBucket: "osf---availability-roster.firebasestorage.app",
          messagingSenderId: "1069751236100",
          appId: "1:1069751236100:web:6a2c9a1570f99927e86751",
          measurementId: "G-JT3PMQ0W6T"
        };
        // ---------------------

        const { useState, useEffect, useMemo } = React;
        let db;
        try {
            if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch(e) { console.error("Firebase init failed", e); }

        const App = () => {
            const [events, setEvents] = useState([]);
            const [settings, setSettings] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [selectedDay, setSelectedDay] = useState(new Date());
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [zoneFilter, setZoneFilter] = useState('All Zones');

            useEffect(() => {
                if (!db) { setError("Calendar could not be loaded."); setIsLoading(false); return; }
                let settingsLoaded = false, eventsLoaded = false;
                const checkLoading = () => { if(settingsLoaded && eventsLoaded) setIsLoading(false); }

                const unsubSettings = db.collection('calendar_settings').doc('main_config').onSnapshot(doc => {
                    if (doc.exists) setSettings(doc.data());
                    else setError("Calendar configuration is missing.");
                    settingsLoaded = true; checkLoading();
                }, err => setError(`Failed to load configuration: ${err.message}`));

                const unsubEvents = db.collection('calendar_events').onSnapshot(snapshot => {
                    setEvents(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), startDateTime: doc.data().startDateTime.toDate(), endDateTime: doc.data().endDateTime.toDate() })));
                    eventsLoaded = true; checkLoading();
                }, err => setError(`Failed to load events: ${err.message}`));
                
                return () => { unsubEvents(); unsubSettings(); };
            }, []);

            const ALL_ZONES_FLAT = useMemo(() => {
                if (!settings?.zones) return ['All Zones'];
                const zones = ['All Zones'];
                settings.zones.forEach(zone => { zones.push(zone.id); if (zone.children) zone.children.forEach(child => zones.push(child.id)); });
                return zones;
            }, [settings]);
            
            const filteredEvents = useMemo(() => {
                if (!events || !settings?.zones) return [];
                if (zoneFilter === 'All Zones') return events;
                const parentZone = settings.zones.find(z => z.id === zoneFilter);
                const childZoneIds = parentZone?.children?.map(c => c.id) || [];
                return events.filter(e => e.zone && e.zone.some(z => z === zoneFilter || childZoneIds.includes(z)));
            }, [events, zoneFilter, settings]);

            const eventsByDate = useMemo(() => {
                const acc = {};
                filteredEvents.forEach(event => {
                    let current = new Date(event.startDateTime);
                    current.setHours(0, 0, 0, 0); 
                    const end = new Date(event.endDateTime);
                    end.setHours(0,0,0,0);
                    while (current <= end) {
                        const key = current.toDateString();
                        if (!acc[key]) acc[key] = [];
                        acc[key].push(event);
                        current.setDate(current.getDate() + 1);
                    }
                });
                return acc;
            }, [filteredEvents]);
            
            const selectedDayEvents = useMemo(() => eventsByDate[selectedDay.toDateString()] || [], [eventsByDate, selectedDay]);

            if (isLoading || !settings) return <div className="text-center p-10">Loading calendar...</div>;

            const changeMonth = (offset) => { setCurrentMonth(prev => { const d = new Date(prev); d.setMonth(prev.getMonth() + offset); return d; }); };

            return (
                <div className="container mx-auto p-4 max-w-6xl">
                    <Header currentMonth={currentMonth} changeMonth={changeMonth} zoneFilter={zoneFilter} setZoneFilter={setZoneFilter} allZones={ALL_ZONES_FLAT} />
                    {error && <p className="text-red-600 my-4">{error}</p>}
                    <div className="flex flex-col lg:grid lg:grid-cols-3 lg:gap-8">
                        <div className="lg:col-span-2 mb-8 lg:mb-0">
                             <CalendarPanel 
                                currentMonth={currentMonth} 
                                eventsByDate={eventsByDate} 
                                selectedDay={selectedDay}
                                onDayClick={setSelectedDay}
                            />
                        </div>
                        <div className="lg:col-span-1">
                            <DailyAgendaPanel 
                                selectedDay={selectedDay}
                                events={selectedDayEvents}
                                onEventClick={setSelectedEvent}
                                eventTypes={settings.eventTypes}
                            />
                        </div>
                    </div>
                    {selectedEvent && <EventModal event={selectedEvent} onClose={() => setSelectedEvent(null)} eventTypes={settings.eventTypes} allZonesConfig={settings.zones} />}
                </div>
            );
        };

        const Header = ({ currentMonth, changeMonth, zoneFilter, setZoneFilter, allZones }) => {
            return (
                 <div className="flex flex-col md:flex-row justify-between items-center mb-6">
                    <div className="flex items-center gap-2">
                        <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-gray-200 text-gray-500">&lt; SEPTEMBER</button>
                        <h2 className="text-3xl font-bold text-center w-64">{currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                        <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-gray-200 text-gray-500">NOVEMBER &gt;</button>
                    </div>
                    <div className="flex items-center gap-4 mt-4 md:mt-0">
                        <select id="zoneFilter" value={zoneFilter} onChange={e => setZoneFilter(e.target.value)} className="bg-white rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                            {allZones.map(zone => <option key={zone} value={zone}>{zone}</option>)}
                        </select>
                    </div>
                </div>
            );
        };
        
        const CalendarPanel = ({ currentMonth, eventsByDate, onDayClick, selectedDay }) => {
            const start = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const end = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
            const startDate = new Date(start);
            startDate.setDate(start.getDate() - start.getDay());
            const endDate = new Date(end);
            endDate.setDate(end.getDate() + (6 - end.getDay()));

            const days = [];
            let d = new Date(startDate);
            while (d <= endDate) { days.push(new Date(d)); d.setDate(d.getDate() + 1); }

            return (
                <div className="bg-white rounded-lg shadow p-4">
                    <div className="grid grid-cols-7 text-center font-bold text-gray-500 text-sm">
                        {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(day => <div key={day} className="py-2">{day}</div>)}
                    </div>
                    <div className="grid grid-cols-7">
                        {days.map(day => {
                            const isSelected = day.toDateString() === selectedDay.toDateString();
                            const isCurrentMonth = day.getMonth() === currentMonth.getMonth();
                            const hasEvents = (eventsByDate[day.toDateString()] || []).length > 0;
                            return (
                                <div key={day.toISOString()} onClick={() => onDayClick(day)} className={`h-20 flex flex-col items-center p-2 border border-transparent cursor-pointer ${isSelected ? 'bg-gray-800 text-white rounded-lg' : 'hover:bg-gray-100'}`}>
                                    <span className={`text-sm font-semibold ${isCurrentMonth ? 'text-gray-700' : 'text-gray-400'} ${isSelected && 'text-white'}`}>{day.getDate()}</span>
                                    {hasEvents && <div className={`w-2 h-2 rounded-full mt-1 ${isSelected ? 'bg-white' : 'bg-gray-400'}`}></div>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        const DailyAgendaPanel = ({ selectedDay, events, onEventClick, eventTypes }) => {
            const formatTime = (date) => date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            return (
                <div className="h-full">
                     <h3 className="text-lg font-bold mb-4">
                        EVENTS FOR <span className="border-b-2 border-gray-800 pb-1">{selectedDay.toLocaleDateString('en-GB', { day: 'numeric' }).toUpperCase()}TH {selectedDay.toLocaleDateString('en-GB', { month: 'long' }).toUpperCase()}</span>
                    </h3>
                    <div className="space-y-4 overflow-y-auto" style={{maxHeight: '70vh'}}>
                        {events.length > 0 ? (
                            events.sort((a,b) => a.startDateTime - b.startDateTime).map(event => (
                                <div key={event.id} onClick={() => onEventClick(event)} className="p-4 rounded-lg cursor-pointer bg-white shadow">
                                    <p className="font-semibold" style={{ color: eventTypes[event.type] || '#1F2937' }}>{event.title}</p>
                                    <div className="text-sm text-gray-500 flex items-center gap-2 mt-1">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                        <span>{formatTime(event.startDateTime)} - {formatTime(event.endDateTime)}</span>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div className="text-center text-gray-500 pt-16 h-full flex flex-col items-center justify-center bg-white rounded-lg shadow">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="text-gray-300 mb-4"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                <p>No scheduled events for this day.</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const EventModal = ({ event, onClose, eventTypes, allZonesConfig }) => {
            if (!event) return null;
            const formatTime = (date) => date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            const processedZones = useMemo(() => {
                if (!event.zone || !allZonesConfig) return [];
                
                let zonesToShow = new Set();
                const eventZonesSet = new Set(event.zone);

                allZonesConfig.forEach(parentZone => {
                    if (eventZonesSet.has(parentZone.id)) {
                        zonesToShow.add(parentZone.id);
                    }
                    if (parentZone.children) {
                        const childIds = parentZone.children.map(c => c.id);
                        const allChildrenSelected = childIds.every(cId => eventZonesSet.has(cId));

                        if (allChildrenSelected && childIds.length > 0) {
                            zonesToShow.add(parentZone.id);
                            childIds.forEach(cId => zonesToShow.delete(cId));
                        } else {
                            childIds.forEach(cId => {
                                if (eventZonesSet.has(cId)) {
                                    zonesToShow.add(cId);
                                }
                            });
                        }
                    }
                });

                return Array.from(zonesToShow);

            }, [event.zone, allZonesConfig]);

            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}>
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-md" onClick={e => e.stopPropagation()}>
                        <div className="p-6">
                            <div className="flex justify-between items-start">
                                <div>
                                    <span className="px-3 py-1 text-xs font-bold rounded-full text-white uppercase" style={{ backgroundColor: eventTypes[event.type] || '#6b7280' }}>{event.type}</span>
                                    <h3 className="text-2xl font-bold mt-2">{event.title}</h3>
                                </div>
                                <button onClick={onClose} className="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                            </div>
                            
                            <div className="mt-6 border-t pt-6 text-gray-700 space-y-5">
                                <div className="flex items-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400 mr-4 mt-1 flex-shrink-0"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
                                    <div>
                                        <p className="font-semibold text-gray-800">Time</p>
                                        <p className="text-gray-600">{formatTime(event.startDateTime)} - {formatTime(event.endDateTime)}</p>
                                    </div>
                                </div>

                                <div className="flex items-start">
                                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400 mr-4 mt-1 flex-shrink-0"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                                    <div>
                                        <p className="font-semibold text-gray-800">Zone(s)</p>
                                        <ul className="list-disc list-inside text-gray-600">
                                            {processedZones.map(zone => <li key={zone}>{zone}</li>)}
                                        </ul>
                                    </div>
                                </div>

                                {event.description && (
                                    <div className="flex items-start">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400 mr-4 mt-1 flex-shrink-0"><line x1="17" y1="10" x2="3" y2="10" /><line x1="21" y1="6" x2="3" y2="6" /><line x1="21" y1="14" x2="3" y2="14" /><line x1="17" y1="18" x2="3" y2="18" /></svg>
                                        <div>
                                            <p className="font-semibold text-gray-800">Details</p>
                                            <p className="text-gray-600">{event.description}</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

