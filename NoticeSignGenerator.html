<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printable Sign Generator - Clarence Regional Aquatic Centre</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Roboto+Condensed:wght@700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles */
        body { font-family: 'Inter', sans-serif; }
        
        .font-condensed { font-family: 'Roboto Condensed', sans-serif; }

        /* A4 Preview Pane */
        #previewPane {
            width: 210mm;
            height: 297mm;
            margin: 0 auto;
            background-color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Print Specifics */
        @media print {
            @page { size: A4 portrait; margin: 0; }
            body, html { margin: 0; padding: 0; background: white; height: 100%; }
            .no-print { display: none !important; }
            
            #previewPane {
                width: 210mm !important;
                height: 297mm !important;
                box-shadow: none !important;
                margin: 0 !important;
                page-break-after: always;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            /* Ensure borders print correctly */
            .border-print-force {
                border: 15mm solid !important; 
            }
        }

        /* Editor Styles */
        .rich-text-editor {
            min-height: 120px;
            max-height: 250px;
            overflow-y: auto;
        }
        .rich-text-editor:focus { outline: none; }
        
        /* Custom Scrollbar for editor */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

<div class="container mx-auto p-4 lg:p-8 max-w-7xl">
    
    <!-- Header -->
    <div class="no-print mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">Printable Sign Generator</h1>
            <p class="text-slate-500 text-sm">Create standard compliant signage for CRAC & YCP</p>
        </div>
        <div class="flex gap-2">
            <button onclick="saveCurrentState()" class="flex items-center gap-2 bg-white border border-slate-300 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-50 transition shadow-sm">
                <i data-lucide="save" class="w-4 h-4"></i> Save Preset
            </button>
            <button onclick="printSign()" class="flex items-center gap-2 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition shadow-md font-bold">
                <i data-lucide="printer" class="w-4 h-4"></i> Print
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
        
        <!-- Controls Sidebar -->
        <div class="no-print xl:col-span-5 space-y-6">
            
            <!-- Saved Presets Area -->
            <div id="savedPresetsContainer" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 hidden">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-2">My Saved Signs</h3>
                <div id="savedPresetsList" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Standard Templates -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <h3 class="text-sm font-bold text-slate-500 uppercase tracking-wider mb-3">Quick Templates</h3>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    <button onclick="loadTemplate('crac_general')" class="text-xs bg-slate-50 hover:bg-blue-50 text-slate-700 hover:text-blue-700 border border-slate-200 hover:border-blue-300 py-2 px-3 rounded transition">CRAC General</button>
                    <button onclick="loadTemplate('ycp_friendly')" class="text-xs bg-slate-50 hover:bg-teal-50 text-slate-700 hover:text-teal-700 border border-slate-200 hover:border-teal-300 py-2 px-3 rounded transition">YCP Friendly</button>
                    <button onclick="loadTemplate('danger_stop')" class="text-xs bg-slate-50 hover:bg-red-50 text-slate-700 hover:text-red-700 border border-slate-200 hover:border-red-300 py-2 px-3 rounded transition">Danger/Stop</button>
                    <button onclick="loadTemplate('cleaning')" class="text-xs bg-slate-50 hover:bg-yellow-50 text-slate-700 hover:text-yellow-700 border border-slate-200 hover:border-yellow-300 py-2 px-3 rounded transition">Cleaning</button>
                </div>
            </div>

            <!-- Accordion Controls -->
            <div class="space-y-4">

                <!-- Section 1: Sign Structure & Safety Header -->
                <div class="bg-white p-5 rounded-xl shadow-md border-l-4 border-blue-500">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="layout-template" class="w-5 h-5 text-blue-500"></i> Structure & Type
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Sign Header Style</label>
                            <select id="signType" onchange="handleSignTypeChange()" class="w-full p-2 border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="none">None (Standard Document)</option>
                                <option value="danger">DANGER (Red)</option>
                                <option value="warning">WARNING (Yellow)</option>
                                <option value="notice">NOTICE (Blue)</option>
                                <option value="information">INFORMATION (Green)</option>
                                <option value="custom">CUSTOM...</option>
                            </select>
                        </div>
                        
                        <!-- Header Customization Controls (Hidden if None) -->
                        <div id="headerCustomControls" class="hidden p-3 bg-slate-50 rounded border border-slate-200 grid grid-cols-3 gap-2">
                             <div class="col-span-2">
                                <label class="block text-xs text-slate-500 mb-1">Header Text</label>
                                <input type="text" id="headerTextInput" oninput="updatePreview()" class="w-full p-1 text-sm border border-slate-300 rounded uppercase font-bold" placeholder="HEADER TEXT">
                             </div>
                             <div>
                                <label class="block text-xs text-slate-500 mb-1">Color</label>
                                <input type="color" id="headerColorInput" oninput="updatePreview()" class="w-full h-8 p-0 border rounded cursor-pointer">
                             </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Page Border</label>
                                <select id="borderStyle" onchange="updatePreview()" class="w-full p-2 border border-slate-300 rounded text-sm">
                                    <option value="none">None</option>
                                    <option value="thin">Thin Grey</option>
                                    <option value="thick-red">Thick Red</option>
                                    <option value="thick-blue">Thick Blue</option>
                                    <option value="hazard">Hazard Stripes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Background Color</label>
                                <div class="flex items-center gap-2">
                                    <input type="color" id="bgColor" value="#ffffff" oninput="updatePreview()" class="h-9 w-12 cursor-pointer border rounded">
                                    <span class="text-xs text-slate-400">Content BG</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Branding & Title -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="type" class="w-5 h-5 text-slate-500"></i> Branding & Title
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Logo</label>
                            <select id="logoSelect" onchange="updatePreview()" class="w-full p-2 border border-slate-300 rounded text-sm mb-2">
                                <option value="crac">Clarence Regional Aquatic Centre</option>
                                <option value="ycp">YCP Yamba Community Pool</option>
                                <option value="none">No Logo</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Main Headline</label>
                            <!-- Textarea to allow multi-line headlines -->
                            <textarea id="headlineInput" oninput="updatePreview()" rows="2" class="w-full p-2 border border-slate-300 rounded font-bold text-lg leading-tight" placeholder="Enter headline here... (Press Enter for new line)">Pool Closure</textarea>
                            
                            <!-- Headline Styles -->
                            <div class="flex gap-2 mt-2">
                                <input type="color" id="headlineColor" value="#1e293b" oninput="updatePreview()" class="h-8 w-8 rounded cursor-pointer border">
                                <input type="number" id="headlineSize" value="48" oninput="updatePreview()" class="w-16 p-1 text-sm border rounded text-center" title="Font Size">
                                <select id="headlineAlign" onchange="updatePreview()" class="text-sm border rounded p-1 flex-grow">
                                    <option value="left">Left</option>
                                    <option value="center" selected>Center</option>
                                    <option value="right">Right</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section 3: Visuals (Icon & Image) -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="image" class="w-5 h-5 text-slate-500"></i> Visuals
                    </h2>

                    <div class="space-y-4">
                        <!-- Icon Control -->
                        <div class="border-b border-slate-100 pb-4">
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Central Icon / Symbol</label>
                            <div class="flex gap-2 mb-2">
                                <select id="iconSelect" onchange="handleIconSelect()" class="flex-grow p-2 border border-slate-300 rounded text-sm">
                                    <option value="none">No Icon</option>
                                    <option value="ban">Prohibited (Ban)</option>
                                    <option value="triangle-alert">Warning (Triangle)</option>
                                    <option value="info">Info (Circle)</option>
                                    <option value="clock">Time / Clock</option>
                                    <option value="waves">Waves / Swim</option>
                                    <option value="sparkles">Cleaning</option>
                                    <option value="custom">Upload Custom Icon...</option>
                                </select>
                                <input type="color" id="iconColor" value="#ef4444" oninput="updatePreview()" class="h-9 w-10 p-0 border-0 rounded cursor-pointer">
                            </div>
                            <input type="file" id="customIconUpload" accept="image/*" onchange="handleCustomIcon(event)" class="hidden w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700">
                        </div>

                        <!-- Main Image Control -->
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Main Image (Optional)</label>
                            <input type="file" id="mainImageUpload" accept="image/*" onchange="handleMainImage(event)" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-slate-100 file:text-slate-700 hover:file:bg-slate-200 mb-2">
                            
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Image Position</label>
                            <select id="imagePosition" onchange="updatePreview()" class="w-full p-2 border border-slate-300 rounded text-sm">
                                <option value="top">Above Text</option>
                                <option value="bottom">Below Text</option>
                                <option value="hidden">Hidden</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section 4: Content Body -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-5 h-5 text-slate-500"></i> Message Body
                    </h2>
                    
                    <div class="mb-2 flex gap-1 bg-slate-50 p-1 rounded border border-slate-200">
                        <button onclick="formatDoc('bold')" class="p-1 hover:bg-slate-200 rounded"><i data-lucide="bold" class="w-4 h-4"></i></button>
                        <button onclick="formatDoc('italic')" class="p-1 hover:bg-slate-200 rounded"><i data-lucide="italic" class="w-4 h-4"></i></button>
                        <button onclick="formatDoc('underline')" class="p-1 hover:bg-slate-200 rounded"><i data-lucide="underline" class="w-4 h-4"></i></button>
                        <div class="w-px h-6 bg-slate-300 mx-1"></div>
                        <button onclick="formatDoc('insertUnorderedList')" class="p-1 hover:bg-slate-200 rounded"><i data-lucide="list" class="w-4 h-4"></i></button>
                        <button onclick="formatDoc('removeFormat')" class="p-1 hover:bg-slate-200 rounded ml-auto"><i data-lucide="eraser" class="w-4 h-4"></i></button>
                    </div>

                    <div id="contentEditor" contenteditable="true" class="rich-text-editor p-3 border border-slate-300 rounded bg-white text-slate-700 mb-3" oninput="updatePreview()">
                        The 50m Pool is closed for winter maintenance.
                    </div>

                    <div class="grid grid-cols-12 gap-2">
                        <div class="col-span-4">
                            <label class="block text-xs text-slate-500">Font Size</label>
                            <input type="number" id="contentSize" value="28" oninput="updatePreview()" class="w-full border rounded p-1">
                        </div>
                        <div class="col-span-4">
                            <label class="block text-xs text-slate-500">Text Align</label>
                            <select id="contentAlign" onchange="updatePreview()" class="w-full border rounded p-1">
                                <option value="left">Left</option>
                                <option value="center" selected>Center</option>
                                <option value="justify">Justify</option>
                            </select>
                        </div>
                        <!-- New Vertical Alignment Control -->
                        <div class="col-span-4">
                            <label class="block text-xs text-slate-500">Vert. Align</label>
                            <select id="contentVerticalAlign" onchange="updatePreview()" class="w-full border rounded p-1">
                                <option value="start" selected>Top</option>
                                <option value="center">Middle</option>
                                <option value="end">Bottom</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Section 5: Footer & QR -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="qr-code" class="w-5 h-5 text-slate-500"></i> Footer & Contact
                    </h2>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Footer Text</label>
                            <input type="text" id="footerText" oninput="updatePreview()" value="Clarence Regional Aquatic Centre" class="w-full p-2 border border-slate-300 rounded">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">QR Code URL (Leave empty to hide)</label>
                            <input type="text" id="qrUrl" oninput="updatePreview()" placeholder="https://..." class="w-full p-2 border border-slate-300 rounded">
                        </div>
                        
                        <!-- NEW QR Controls -->
                        <div class="grid grid-cols-2 gap-4 pt-2 border-t border-slate-100">
                             <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">QR Position</label>
                                <select id="qrPosition" onchange="updatePreview()" class="w-full p-1 text-sm border border-slate-300 rounded">
                                    <option value="right" selected>Right</option>
                                    <option value="left">Left</option>
                                    <option value="center">Center</option>
                                </select>
                             </div>
                             <div>
                                <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">QR Size</label>
                                <input type="range" id="qrSize" oninput="updatePreview()" min="50" max="250" value="100" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                             </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Preview Area -->
        <div class="xl:col-span-7 flex flex-col items-center">
            <div id="previewPane" class="relative">
                
                <!-- Page Border Layer (Z-Index Lowered) -->
                <div id="previewBorder" class="absolute inset-0 pointer-events-none z-40"></div>

                <!-- Safety Header (Z-Index Raised to overlap border) -->
                <div id="safetyHeader" class="hidden w-full text-white text-center font-black uppercase tracking-widest flex items-center justify-center font-condensed z-50" style="height: 12%;">
                    <div class="flex items-center justify-center gap-4 text-5xl">
                        <span id="safetyHeaderText">DANGER</span>
                    </div>
                </div>

                <!-- Main Content Container -->
                <div id="previewContentContainer" class="flex-grow flex flex-col p-12 z-30 transition-colors duration-300">
                    
                    <!-- Top Logo -->
                    <div class="flex justify-center mb-6 h-16 shrink-0">
                        <img id="previewLogo" src="" class="h-full object-contain" onerror="this.style.display='none'">
                    </div>

                    <!-- Headline -->
                    <div id="previewHeadline" class="font-bold mb-6 break-words leading-tight shrink-0"></div>

                    <!-- Dynamic Content Area (ID Added for Vertical Align) -->
                    <div id="dynamicContentArea" class="flex-grow flex flex-col items-center justify-center gap-6 overflow-hidden">
                        
                        <!-- Icon -->
                        <div id="previewIcon" class="shrink-0 transition-all duration-300"></div>

                        <!-- Image (Position Controlled via JS) -->
                        <div id="previewImageContainer" class="hidden shrink-0">
                            <img id="previewImage" src="" class="max-h-[300px] max-w-full object-contain shadow-sm rounded">
                        </div>

                        <!-- Body Text -->
                        <div id="previewBody" class="w-full break-words"></div>

                    </div>

                    <!-- Footer -->
                    <div id="footerContainer" class="mt-auto pt-8 border-t border-slate-300/50 flex justify-between items-end shrink-0">
                        <div id="previewFooter" class="text-slate-600 font-medium"></div>
                        <img id="previewQr" src="" class="hidden w-24 h-24 mix-blend-multiply">
                    </div>

                </div>
            </div>
            
            <!-- Overflow Warning -->
            <div id="overflowWarning" class="no-print hidden mt-4 bg-red-100 text-red-700 px-4 py-2 rounded-lg flex items-center gap-2">
                <i data-lucide="alert-circle" class="w-5 h-5"></i>
                <strong>Warning:</strong> Content is overflowing. Try reducing font size or image size.
            </div>
        </div>
    </div>
</div>

<script>
    // State
    let mainImageData = null;
    let customIconData = null;

    // Assets
    const logos = {
        crac: "https://raw.githubusercontent.com/Brisk3r/CRAC---Tools-and-Requests/98325202cc3f831a80e250d16d0c56168515c40a/CRAC%20Large%20Wordmark2.png",
        ycp: "https://raw.githubusercontent.com/Brisk3r/CRAC---Tools-and-Requests/aec03b349e712519927321f47dade540f2b5bce9/YCP%20Wordmark%20-%20Full%20Horizontal.png",
        none: ""
    };

    const safetyStyles = {
        none: { bg: 'transparent', text: '', class: '', textCol: '#000000' },
        danger: { bg: '#dc2626', text: 'DANGER', class: 'bg-red-600', textCol: '#ffffff' }, // Red
        warning: { bg: '#eab308', text: 'WARNING', class: 'bg-yellow-500 text-black', textCol: '#000000' }, // Yellow
        notice: { bg: '#2563eb', text: 'NOTICE', class: 'bg-blue-600', textCol: '#ffffff' }, // Blue
        information: { bg: '#22c55e', text: 'INFORMATION', class: 'bg-green-500', textCol: '#ffffff' }, // Green
        custom: { bg: '#000000', text: 'CUSTOM', class: 'bg-black', textCol: '#ffffff' }
    };

    // --- Core Functions ---

    function handleSignTypeChange() {
        const signType = document.getElementById('signType').value;
        const controls = document.getElementById('headerCustomControls');
        const textInput = document.getElementById('headerTextInput');
        const colorInput = document.getElementById('headerColorInput');
        
        if (signType === 'none') {
            controls.classList.add('hidden');
        } else {
            controls.classList.remove('hidden');
            // Pre-fill controls with defaults if not already modified or if switching types
            // We use the safetyStyles map to get defaults
            if (safetyStyles[signType]) {
                textInput.value = safetyStyles[signType].text;
                colorInput.value = safetyStyles[signType].bg;
            }
        }
        updatePreview();
    }

    function updatePreview() {
        // 1. Safety Header (Z-Index 50 - Above Border)
        const signType = document.getElementById('signType').value;
        const headerEl = document.getElementById('safetyHeader');
        const headerTextEl = document.getElementById('safetyHeaderText');
        
        if (signType === 'none') {
            headerEl.classList.add('hidden');
        } else {
            headerEl.classList.remove('hidden');
            
            // Get values from custom controls
            const customText = document.getElementById('headerTextInput').value;
            const customColor = document.getElementById('headerColorInput').value;
            
            headerTextEl.innerText = customText || safetyStyles[signType].text;
            headerEl.style.backgroundColor = customColor;
            
            // Auto-detect text color based on brightness (simple check)
            if (customColor.toLowerCase() === '#eab308' || signType === 'warning') {
                headerEl.style.color = 'black';
            } else {
                headerEl.style.color = 'white';
            }
        }

        // 2. Borders (Z-Index 40 - Below Header)
        const borderStyle = document.getElementById('borderStyle').value;
        const borderEl = document.getElementById('previewBorder');
        borderEl.style.border = 'none'; // reset
        borderEl.style.borderImage = 'none';

        if (borderStyle === 'thin') borderEl.style.border = '1px solid #cbd5e1';
        if (borderStyle === 'thick-red') borderEl.style.border = '15mm solid #dc2626';
        if (borderStyle === 'thick-blue') borderEl.style.border = '15mm solid #2563eb';
        if (borderStyle === 'hazard') {
            borderEl.style.border = '15mm solid #facc15';
            borderEl.style.borderImage = 'repeating-linear-gradient(45deg, #facc15, #facc15 15px, #000 15px, #000 30px) 60';
        }
        
        // Add specific class for print forcing
        if (borderStyle !== 'thin' && borderStyle !== 'none') {
            borderEl.classList.add('border-print-force');
        } else {
            borderEl.classList.remove('border-print-force');
        }

        // 3. Background & Branding
        document.getElementById('previewContentContainer').style.backgroundColor = document.getElementById('bgColor').value;
        
        const logoVal = document.getElementById('logoSelect').value;
        const logoImg = document.getElementById('previewLogo');
        if (logoVal !== 'none') {
            logoImg.src = logos[logoVal];
            logoImg.style.display = 'block';
        } else {
            logoImg.style.display = 'none';
        }

        // 4. Headline
        const hl = document.getElementById('previewHeadline');
        // Use innerHTML to allow breaks
        hl.innerHTML = document.getElementById('headlineInput').value.replace(/\n/g, '<br>');
        hl.style.color = document.getElementById('headlineColor').value;
        hl.style.fontSize = document.getElementById('headlineSize').value + 'px';
        hl.style.textAlign = document.getElementById('headlineAlign').value;

        // 5. Icons
        const iconVal = document.getElementById('iconSelect').value;
        const iconContainer = document.getElementById('previewIcon');
        iconContainer.innerHTML = '';
        
        if (iconVal === 'custom' && customIconData) {
            const img = document.createElement('img');
            img.src = customIconData;
            img.style.height = '120px';
            img.style.width = 'auto';
            iconContainer.appendChild(img);
        } else if (iconVal !== 'none' && iconVal !== 'custom') {
            const i = document.createElement('i');
            i.setAttribute('data-lucide', iconVal);
            i.style.color = document.getElementById('iconColor').value;
            iconContainer.appendChild(i);
            lucide.createIcons({
                attrs: { width: 120, height: 120, 'stroke-width': 1.5 }
            });
        }

        // 6. Main Image
        const imgContainer = document.getElementById('previewImageContainer');
        const imgPos = document.getElementById('imagePosition').value;
        const bodyText = document.getElementById('previewBody');
        
        if (mainImageData && imgPos !== 'hidden') {
            document.getElementById('previewImage').src = mainImageData;
            imgContainer.classList.remove('hidden');
            // Logic to swap order
            if (imgPos === 'top') {
                imgContainer.parentNode.insertBefore(imgContainer, bodyText);
            } else {
                imgContainer.parentNode.insertBefore(bodyText, imgContainer);
            }
        } else {
            imgContainer.classList.add('hidden');
        }

        // 7. Body Content & Alignment
        bodyText.innerHTML = document.getElementById('contentEditor').innerHTML;
        bodyText.style.fontSize = document.getElementById('contentSize').value + 'px';
        bodyText.style.textAlign = document.getElementById('contentAlign').value;

        // Apply Vertical Alignment
        const vertAlign = document.getElementById('contentVerticalAlign').value;
        const dynamicArea = document.getElementById('dynamicContentArea');
        dynamicArea.classList.remove('justify-start', 'justify-center', 'justify-end');
        dynamicArea.classList.add('justify-' + vertAlign);

        // 8. Footer & QR
        const footerContainer = document.getElementById('footerContainer');
        const footerText = document.getElementById('previewFooter');
        const qrImg = document.getElementById('previewQr');
        const footerTextVal = document.getElementById('footerText').value;
        const qrUrl = document.getElementById('qrUrl').value;
        const qrPos = document.getElementById('qrPosition').value;
        const qrSize = document.getElementById('qrSize').value;

        footerText.innerText = footerTextVal;
        
        // QR Logic
        if (qrUrl.trim()) {
            qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(qrUrl)}`;
            qrImg.classList.remove('hidden');
            qrImg.style.width = qrSize + 'px';
            qrImg.style.height = qrSize + 'px';
            
            // Positioning Logic
            footerContainer.className = 'mt-auto pt-8 border-t border-slate-300/50 flex shrink-0'; // Reset base classes
            
            if (qrPos === 'right') {
                footerContainer.classList.add('justify-between', 'items-end', 'flex-row');
                footerContainer.appendChild(footerText); // Ensure text is first
                footerContainer.appendChild(qrImg); // QR second
                footerText.style.textAlign = 'left';
            } else if (qrPos === 'left') {
                footerContainer.classList.add('justify-between', 'items-end', 'flex-row');
                footerContainer.appendChild(qrImg); // QR first
                footerContainer.appendChild(footerText); // Text second
                footerText.style.textAlign = 'right';
            } else if (qrPos === 'center') {
                footerContainer.classList.add('flex-col', 'items-center', 'justify-center', 'gap-4');
                footerContainer.appendChild(footerText);
                footerContainer.appendChild(qrImg);
                footerText.style.textAlign = 'center';
            }

        } else {
            qrImg.classList.add('hidden');
            // Reset footer alignment if no QR
            footerContainer.className = 'mt-auto pt-8 border-t border-slate-300/50 flex justify-center items-end shrink-0';
            footerContainer.appendChild(footerText); // Just text
            footerText.style.textAlign = 'center';
        }

        checkOverflow();
    }

    // --- Logic Functions ---

    function handleIconSelect() {
        const val = document.getElementById('iconSelect').value;
        const upload = document.getElementById('customIconUpload');
        if (val === 'custom') {
            upload.classList.remove('hidden');
        } else {
            upload.classList.add('hidden');
            updatePreview();
        }
    }

    function handleCustomIcon(e) {
        const reader = new FileReader();
        reader.onload = (e) => {
            customIconData = e.target.result;
            updatePreview();
        };
        if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
    }

    function handleMainImage(e) {
        const reader = new FileReader();
        reader.onload = (e) => {
            mainImageData = e.target.result;
            updatePreview();
        };
        if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
    }

    function formatDoc(cmd) {
        document.execCommand(cmd, false, null);
        document.getElementById('contentEditor').focus();
        updatePreview();
    }

    function checkOverflow() {
        const pane = document.getElementById('previewPane');
        // Simple check: is scrollHeight > offsetHeight?
        if (pane.scrollHeight > pane.clientHeight + 2) { // +2 buffer
            document.getElementById('overflowWarning').classList.remove('hidden');
        } else {
            document.getElementById('overflowWarning').classList.add('hidden');
        }
    }

    function printSign() {
        window.print();
    }

    // --- Templates & Presets ---

    const templates = {
        crac_general: {
            type: 'none', border: 'none', logo: 'crac', 
            hlText: 'Pool Closure', hlColor: '#1e293b', hlSize: 48,
            icon: 'ban', iconColor: '#dc2626', bg: '#ffffff',
            body: 'The 50m Pool is closed for maintenance.',
            footer: 'Clarence Regional Aquatic Centre'
        },
        ycp_friendly: {
            type: 'none', border: 'thick-blue', logo: 'ycp',
            hlText: 'Lane Reserved', hlColor: '#2563eb', hlSize: 42,
            icon: 'clock', iconColor: '#2563eb', bg: '#eff6ff',
            body: 'This lane is reserved for swim squad training.<br>Please use alternative lanes.',
            footer: 'Yamba Community Pool'
        },
        danger_stop: {
            type: 'danger', border: 'hazard', logo: 'none',
            hlText: 'DO NOT ENTER', hlColor: '#000000', hlSize: 60,
            icon: 'triangle-alert', iconColor: '#dc2626', bg: '#ffffff',
            body: 'Chemical handling in progress.<br>Authorised Personnel Only.',
            footer: 'Clarence Valley Council'
        },
        cleaning: {
            type: 'warning', border: 'none', logo: 'crac',
            hlText: 'Cleaning In Progress', hlColor: '#000000', hlSize: 42,
            icon: 'sparkles', iconColor: '#eab308', bg: '#fefce8',
            body: 'Floors may be slippery. Please watch your step.',
            footer: 'Clarence Regional Aquatic Centre'
        }
    };

    function loadTemplate(key) {
        const t = templates[key];
        document.getElementById('signType').value = t.type;
        document.getElementById('borderStyle').value = t.border;
        document.getElementById('logoSelect').value = t.logo;
        document.getElementById('headlineInput').value = t.hlText;
        document.getElementById('headlineColor').value = t.hlColor;
        document.getElementById('headlineSize').value = t.hlSize;
        document.getElementById('iconSelect').value = t.icon;
        document.getElementById('iconColor').value = t.iconColor;
        document.getElementById('bgColor').value = t.bg;
        document.getElementById('contentEditor').innerHTML = t.body;
        document.getElementById('footerText').value = t.footer;
        
        handleIconSelect(); // Reset custom upload visibility
        handleSignTypeChange(); // Ensure header controls update
        updatePreview();
    }

    // --- Local Storage (Save/Load) ---

    function saveCurrentState() {
        const name = prompt("Enter a name for this preset (e.g., 'Weekly Cleaning'):");
        if (!name) return;

        const state = {
            headline: document.getElementById('headlineInput').value,
            content: document.getElementById('contentEditor').innerHTML,
            signType: document.getElementById('signType').value,
            logo: document.getElementById('logoSelect').value,
            // We only save the key configurations, not images (too big for localstorage usually)
            footer: document.getElementById('footerText').value,
            headerText: document.getElementById('headerTextInput').value,
            headerColor: document.getElementById('headerColorInput').value
        };

        const saves = JSON.parse(localStorage.getItem('mySignPresets') || '{}');
        saves[name] = state;
        localStorage.setItem('mySignPresets', JSON.stringify(saves));
        refreshSavedList();
    }

    function loadPreset(name) {
        const saves = JSON.parse(localStorage.getItem('mySignPresets'));
        if (saves && saves[name]) {
            const s = saves[name];
            document.getElementById('headlineInput').value = s.headline;
            document.getElementById('contentEditor').innerHTML = s.content;
            document.getElementById('signType').value = s.signType;
            document.getElementById('logoSelect').value = s.logo;
            document.getElementById('footerText').value = s.footer;
            if(s.headerText) document.getElementById('headerTextInput').value = s.headerText;
            if(s.headerColor) document.getElementById('headerColorInput').value = s.headerColor;
            
            handleSignTypeChange();
            updatePreview();
        }
    }

    function deletePreset(name) {
        if(confirm('Delete preset: ' + name + '?')) {
            const saves = JSON.parse(localStorage.getItem('mySignPresets'));
            delete saves[name];
            localStorage.setItem('mySignPresets', JSON.stringify(saves));
            refreshSavedList();
        }
    }

    function refreshSavedList() {
        const container = document.getElementById('savedPresetsContainer');
        const list = document.getElementById('savedPresetsList');
        const saves = JSON.parse(localStorage.getItem('mySignPresets') || '{}');
        
        list.innerHTML = '';
        const keys = Object.keys(saves);
        
        if (keys.length > 0) {
            container.classList.remove('hidden');
            keys.forEach(k => {
                const badge = document.createElement('div');
                badge.className = "flex items-center bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded border border-blue-200";
                badge.innerHTML = `
                    <span class="cursor-pointer font-medium mr-2" onclick="loadPreset('${k}')">${k}</span>
                    <button onclick="deletePreset('${k}')" class="text-blue-400 hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button>
                `;
                list.appendChild(badge);
            });
        } else {
            container.classList.add('hidden');
        }
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        refreshSavedList();
        handleSignTypeChange(); // Initialize controls
        updatePreview();
    });

</script>

</body>
</html>
