
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sports Field Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-100 font-sans text-gray-900">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect } = React;
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA-AwiFvSq3_AuDVZE5l1Pn4oAIfZTFmOM",
            authDomain: "opsf---comms-task-tracker.firebaseapp.com",
            projectId: "opsf---comms-task-tracker",
            storageBucket: "opsf---comms-task-tracker.firebasestorage.app",
            messagingSenderId: "489224390639",
            appId: "1:489224390639:web:c5da72d0dc302d8332581a",
            measurementId: "G-CBJK0070Z1"
        };

        const getFieldsCol = (db) => collection(db, "sports_fields_status");
        const getStatusDoc = (db) => doc(db, "sports_fields_status_config", "statuses");

        const LoadingSpinner = () => (
            <div className="flex items-center justify-center p-10">
                <svg className="animate-spin -ml-1 mr-3 h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        );

        const DisplayPage = ({ db }) => {
            const [fields, setFields] = useState([]);
            const [statuses, setStatuses] = useState({});
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!db) return;
                setLoading(true);
                const subs = [];
                try {
                    subs.push(onSnapshot(getStatusDoc(db), (docSnap) => {
                        const statusOptions = docSnap.data()?.options || [];
                        const statusMap = statusOptions.reduce((acc, status) => { acc[status.id] = status; return acc; }, {});
                        setStatuses(statusMap);
                    }));
                    subs.push(onSnapshot(query(getFieldsCol(db)), (snapshot) => {
                        const fieldList = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
                        setFields(fieldList);
                        setLoading(false);
                    }));
                } catch (err) { setError("Could not load data."); setLoading(false); }
                return () => subs.forEach(unsub => unsub());
            }, [db]);

            if (loading) return <LoadingSpinner />;
            if (error) return <div className="p-4 text-center text-red-600">{error}</div>;

            const getStatusColor = (status) => {
                const color = status?.color || "#808080";
                const hex = color.replace("#", "");
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                const textColor = ((r * 299 + g * 587 + b * 114) / 1000) > 150 ? "text-black" : "text-white";
                return { backgroundColor: color, textColor };
            };

            const lastUpdated = new Date().toLocaleString('en-AU', { dateStyle: 'medium', timeStyle: 'short', hour12: true });

            return (
                <div className="mx-auto max-w-4xl p-4 sm:p-6">
                    <h1 className="mb-6 text-center text-3xl font-bold text-gray-800">Sports Field Status</h1>
                    {fields.length === 0 ? (
                        <p className="text-center text-lg text-gray-500">No sports fields have been configured yet.</p>
                    ) : (
                        <div className="space-y-4">
                            {fields.map((field) => {
                                const status = statuses[field.currentStatusId] || { text: "Unknown", color: "#808080" };
                                const { backgroundColor, textColor } = getStatusColor(status);
                                const isLink = !!status.infoLink;
                                const BadgeComponent = isLink ? 'a' : 'span';
                                const badgeProps = isLink ? { href: status.infoLink, target: "_blank", rel: "noopener noreferrer", title: "Click to view policy/info" } : {};

                                return (
                                    <div key={field.id} className="flex flex-col rounded-lg bg-white p-5 shadow-md transition-shadow hover:shadow-lg sm:flex-row sm:items-start sm:justify-between">
                                        <div className="flex flex-col flex-grow pr-4">
                                            <h2 className="mb-2 text-xl font-semibold text-gray-900">{field.name}</h2>
                                            {(field.webLink || field.mapLink) && (
                                                <div className="flex flex-wrap gap-3 mt-1">
                                                    {field.webLink && <a href={field.webLink} target="_blank" rel="noopener noreferrer" className="flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline"><svg className="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>More Info</a>}
                                                    {field.mapLink && <a href={field.mapLink} target="_blank" rel="noopener noreferrer" className="flex items-center text-sm text-blue-600 hover:text-blue-800 hover:underline"><svg className="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Directions</a>}
                                                </div>
                                            )}
                                        </div>
                                        <div className="mt-4 sm:mt-0 flex-shrink-0">
                                            <BadgeComponent {...badgeProps} className={`inline-flex items-center justify-center rounded-full px-4 py-2 text-sm font-bold ${textColor} text-center w-full sm:w-auto transition-transform ${isLink ? 'hover:scale-105 hover:underline cursor-pointer' : ''}`} style={{ backgroundColor }}>
                                            {status.text}
                                            {isLink && <svg className="w-4 h-4 ml-2 opacity-80" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>}
                                            </BadgeComponent>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}
                    <p className="mt-8 text-center text-sm text-gray-400">Last updated: {lastUpdated}</p>
                </div>
            );
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);

            useEffect(() => {
                try {
                    const app = initializeApp(firebaseConfig);
                    setDb(getFirestore(app));
                    const firebaseAuth = getAuth(app);
                    setAuth(firebaseAuth);
                    onAuthStateChanged(firebaseAuth, async (user) => {
                        if (!user) await signInAnonymously(firebaseAuth);
                        setIsAuthReady(true);
                    });
                } catch (err) { console.error(err); }
            }, []);

            if (!isAuthReady) return <LoadingSpinner />;
            return (
                <div className="min-h-screen bg-gray-100 font-sans">
                    <main><DisplayPage db={db} /></main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
