<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Tracker | Ops Hub</title>
    <!-- Core Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
        
        window.firebaseModules = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, signOut, getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        [x-cloak] { display: none !important; }
        
        /* Kanban specific styles */
        .kanban-column { min-height: 400px; }
        .timeline-scroll::-webkit-scrollbar { height: 10px; }
        .timeline-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 6px; }
        .timeline-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 6px; border: 2px solid #f1f5f9; }
        .timeline-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Modal Animation */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-animate { animation: fadeIn 0.2s ease-out; }

        /* Improved Resize Handles */
        .resize-handle {
            position: absolute; top: 0; bottom: 0; width: 20px; /* Wider hit target */
            cursor: ew-resize; z-index: 20; display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .resize-handle:hover { opacity: 1; background-color: rgba(255,255,255,0.1); }
        .resize-handle::after {
            content: ''; height: 16px; width: 4px; 
            background-color: white; 
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .resize-handle-left { left: 0; border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .resize-handle-right { right: 0; border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
        
        /* Show handles when hovering the bar */
        .task-bar:hover .resize-handle { opacity: 0.4; }
        .task-bar .resize-handle:hover { opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- Standard Header with Back Button -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 text-slate-500 hover:text-orange-600 transition-colors font-medium">
                <i class="ph-bold ph-arrow-left"></i>
                <span>Back to Hub</span>
            </a>
            <div class="flex items-center gap-2">
                <span class="text-sm font-semibold text-slate-700">Task Tracker</span>
                <div class="bg-orange-500 text-white p-1.5 rounded-md">
                    <i class="ph-bold ph-list-checks"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- React Root -->
    <div id="root" class="flex-grow flex flex-col"></div>

    <!-- Simple Footer -->
    <footer class="py-6 text-center text-xs text-slate-400">
        &copy; Clarence Valley Council - Operations Hub
    </footer>

    <!-- App Logic -->
    <script type="text/babel" data-type="module" data-presets="react">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- Icons (Phosphor wrappers) ---
        const IconWrapper = ({ className, children, onClick }) => <i className={`ph-bold ${className}`} onClick={onClick}>{children}</i>;

        // --- Styles & Maps ---
        const priorityMap = { 
            High: { icon: "ph-caret-double-up", color: 'text-red-500', bg: 'bg-red-50', border: 'border-red-200', value: 3 }, 
            Medium: { icon: "ph-equals", color: 'text-orange-500', bg: 'bg-orange-50', border: 'border-orange-200', value: 2 }, 
            Low: { icon: "ph-caret-down", color: 'text-green-500', bg: 'bg-green-50', border: 'border-green-200', value: 1 } 
        };
        
        const statusMap = { 
            'To Do': { borderTop: 'border-t-slate-400', badge: 'bg-slate-100 text-slate-600' }, 
            'In Progress': { borderTop: 'border-t-orange-500', badge: 'bg-orange-100 text-orange-700' }, 
            'Completed': { borderTop: 'border-t-green-500', badge: 'bg-green-100 text-green-700' } 
        };

        // --- Components ---

        const LoginScreen = ({ onLogin, isAuthReady, error }) => {
            const [name, setName] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); if(name.trim()) onLogin(name.trim()); };

            return (
                <main className="flex-grow max-w-md mx-auto px-4 py-20 w-full">
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-8 text-center">
                        <div className="bg-orange-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-600 text-3xl">
                            <i className="ph-bold ph-user-circle"></i>
                        </div>
                        <h1 className="text-2xl font-bold text-slate-900 mb-2">Team Access</h1>
                        <p className="text-slate-500 mb-8">Enter your name to view the task board.</p>

                        {!isAuthReady ? (
                            <div className="flex flex-col items-center justify-center py-4 gap-2">
                                <i className="ph-duotone ph-spinner animate-spin text-2xl text-orange-500"></i>
                                <span className="text-xs text-slate-400">Connecting to secure storage...</span>
                            </div>
                        ) : (
                            <form onSubmit={handleSubmit} className="space-y-4 text-left">
                                <div>
                                    <label className="block text-sm font-medium text-slate-700 mb-1">Your Name</label>
                                    <input type="text" value={name} onChange={e => setName(e.target.value)} 
                                        className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all"
                                        placeholder="e.g. Avi" autoFocus />
                                </div>
                                <button type="submit" className="w-full bg-orange-600 text-white font-semibold py-3 rounded-lg hover:bg-orange-700 transition-colors shadow-sm">
                                    Access Workspace
                                </button>
                                {error && <p className="text-xs text-red-500 text-center mt-2">{error}</p>}
                            </form>
                        )}
                    </div>
                </main>
            );
        };

        const TaskCard = ({ task, onEdit }) => {
            const handleDragStart = (e) => { e.dataTransfer.setData('taskId', task.id); };
            const priority = priorityMap[task.priority] || priorityMap.Medium;
            const today = new Date(); today.setHours(0,0,0,0);
            const dueDate = new Date(task.dueDate);
            const isOverdue = dueDate < today;
            const isDueSoon = !isOverdue && (dueDate - today) / (1000 * 60 * 60 * 24) <= 3;
            const dateColor = isOverdue ? 'text-red-600 font-semibold' : isDueSoon ? 'text-orange-600 font-medium' : 'text-slate-400';

            return (
                <div draggable onDragStart={handleDragStart} onClick={() => onEdit(task)} 
                    className="group bg-white p-4 rounded-lg shadow-sm border border-slate-200 hover:shadow-md hover:border-orange-300 cursor-grab active:cursor-grabbing transition-all relative">
                    
                    <div className="flex justify-between items-start mb-2">
                        <p className="font-semibold text-slate-800 text-sm leading-tight pr-2">{task.title}</p>
                    </div>
                    
                    <div className="flex items-center gap-2 mb-3">
                        {task.assignedTo && (
                            <span className="text-[10px] bg-slate-100 text-slate-600 font-medium px-2 py-0.5 rounded-full border border-slate-200 truncate max-w-[100px]">
                                {task.assignedTo}
                            </span>
                        )}
                    </div>

                    <div className="flex justify-between items-center text-xs pt-2 border-t border-slate-100">
                        <div className={`flex items-center gap-1 font-medium ${priority.color}`}>
                            <i className={priority.icon}></i> {task.priority}
                        </div>
                        <div className="flex items-center gap-3">
                            {task.dueDate && (
                                <div className={`flex items-center gap-1 ${dateColor}`} title="Due Date">
                                    <i className="ph-bold ph-calendar-blank"></i>
                                    <span>{new Date(task.dueDate).toLocaleDateString('en-AU', {month:'short', day:'numeric'})}</span>
                                </div>
                            )}
                            {task.updates?.length > 0 && (
                                <div className="flex items-center gap-1 text-slate-400" title="Comments">
                                    <i className="ph-bold ph-chat-circle"></i> <span>{task.updates.length}</span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const TaskModal = ({ task, onClose, onSave, onDelete, currentUser }) => {
            const today = new Date().toISOString().split('T')[0];
            const [formData, setFormData] = useState({
                title: '', description: '', priority: 'Medium', startDate: today, dueDate: today,
                assignedTo: currentUser === 'Admin' ? '' : currentUser
            });
            const [newUpdate, setNewUpdate] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => { 
                if (task) { 
                    setFormData({
                        title: task.title || '', description: task.description || '', priority: task.priority || 'Medium',
                        startDate: task.startDate || today, dueDate: task.dueDate || today,
                        assignedTo: task.assignedTo || (currentUser === 'Admin' ? '' : currentUser)
                    });
                } 
            }, [task, currentUser]);
            
            const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));

            const handleSave = async () => {
                if (!formData.title.trim()) return;
                setIsSaving(true);
                await onSave({ ...(task || {}), ...formData }, true);
            };
            
            const handleAddUpdate = async () => {
                if (!newUpdate.trim()) return;
                setIsSaving(true);
                const update = { text: newUpdate, date: new Date().toISOString(), author: currentUser };
                await onSave({ ...task, updates: [...(task.updates || []), update] }, false);
                setNewUpdate('');
                setIsSaving(false); 
            };

            const handleDelete = () => {
                if (window.confirm("Are you sure you want to permanently delete this task?")) onDelete(task.id);
            };

            return (
                <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 modal-animate">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl relative flex flex-col h-[90vh] max-h-[700px]">
                        
                        <header className="p-5 border-b border-slate-100 flex justify-between items-center rounded-t-xl bg-slate-50">
                            <h2 className="text-lg font-bold text-slate-800">{task?.id ? 'Edit Task' : 'New Task'}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 p-1 rounded-md hover:bg-slate-200 transition-colors">
                                <i className="ph-bold ph-x text-xl"></i>
                            </button>
                        </header>
                        
                        <div className="p-6 overflow-y-auto flex-grow space-y-5">
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Title</label>
                                <input type="text" value={formData.title} onChange={e => handleChange('title', e.target.value)} 
                                    className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none font-medium text-slate-800" 
                                    placeholder="What needs doing?" autoFocus />
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Assigned To</label>
                                    <input type="text" value={formData.assignedTo} onChange={e => handleChange('assignedTo', e.target.value)} 
                                        className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none" placeholder="Name" />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Priority</label>
                                    <select value={formData.priority} onChange={e => handleChange('priority', e.target.value)} 
                                        className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none bg-white">
                                        <option>Low</option>
                                        <option>Medium</option>
                                        <option>High</option>
                                    </select>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Start Date</label>
                                    <input type="date" value={formData.startDate} onChange={e => handleChange('startDate', e.target.value)} 
                                        className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none text-slate-600" />
                                </div>
                                <div>
                                    <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Due Date</label>
                                    <input type="date" value={formData.dueDate} onChange={e => handleChange('dueDate', e.target.value)} 
                                        className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none text-slate-600" />
                                </div>
                            </div>

                            <div>
                                <label className="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1">Description</label>
                                <textarea value={formData.description} onChange={e => handleChange('description', e.target.value)} rows="3" 
                                    className="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none text-sm" 
                                    placeholder="Add details..."></textarea>
                            </div>

                            {task?.id && (
                                <div className="pt-4 border-t border-slate-100">
                                    <h3 className="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                                        <i className="ph-bold ph-chat-circle-text"></i> Activity Log
                                    </h3>
                                    <div className="space-y-3 mb-4 max-h-40 overflow-y-auto pr-2">
                                        {task.updates?.sort((a,b) => new Date(b.date) - new Date(a.date)).map((upd, i) => (
                                            <div key={i} className="bg-slate-50 p-3 rounded-lg border border-slate-200">
                                                <div className="flex justify-between items-start mb-1">
                                                    <span className="text-xs font-bold text-orange-600">{upd.author || 'User'}</span>
                                                    <span className="text-[10px] text-slate-400">{new Date(upd.date).toLocaleString()}</span>
                                                </div>
                                                <p className="text-sm text-slate-600 whitespace-pre-wrap">{upd.text}</p>
                                            </div>
                                        ))}
                                        {(!task.updates || task.updates.length === 0) && <p className="text-sm text-slate-400 italic">No updates yet.</p>}
                                    </div>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="Write an update..." value={newUpdate} onChange={e => setNewUpdate(e.target.value)} 
                                            className="flex-grow px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none text-sm" />
                                        <button onClick={handleAddUpdate} disabled={isSaving || !newUpdate.trim()} 
                                            className="bg-slate-800 hover:bg-slate-700 text-white font-semibold py-2 px-4 rounded-lg disabled:opacity-50 transition-colors">
                                            Post
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        <footer className="p-5 border-t border-slate-100 bg-slate-50 rounded-b-xl flex justify-between items-center">
                            {task?.id ? (
                                <button onClick={handleDelete} className="flex items-center gap-2 text-red-500 hover:text-red-700 hover:bg-red-50 py-2 px-3 rounded-lg transition-colors text-sm font-medium">
                                    <i className="ph-bold ph-trash"></i> Delete
                                </button>
                            ) : <div></div>}
                            <button onClick={handleSave} disabled={isSaving} className="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-lg shadow-sm transition-colors flex items-center gap-2">
                                {isSaving && <i className="ph-duotone ph-spinner animate-spin"></i>}
                                {task?.id ? 'Save Changes' : 'Create Task'}
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };

        const KanbanColumn = ({ title, tasks, onAddTask, onEditTask, onDrop }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            const statusConfig = statusMap[title] || statusMap['To Do'];
            
            const handleDragOver = (e) => { e.preventDefault(); setIsDragOver(true); };
            const handleDragLeave = () => setIsDragOver(false);
            const handleDrop = (e) => { e.preventDefault(); onDrop(e.dataTransfer.getData('taskId')); setIsDragOver(false); };

            return (
                <div className={`flex-1 flex flex-col rounded-xl transition-colors border-2 ${isDragOver ? 'border-orange-400 bg-orange-50' : 'border-transparent bg-slate-100/50'}`}
                    onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}>
                    
                    <div className={`flex items-center justify-between p-4 border-t-4 bg-white rounded-t-xl shadow-sm border-x border-b border-slate-200 ${statusConfig.borderTop}`}>
                        <h2 className="text-sm font-bold text-slate-800 flex items-center gap-2">
                            {title}
                            <span className={`text-[10px] px-2 py-0.5 rounded-full ${statusConfig.badge}`}>{tasks.length}</span>
                        </h2>
                    </div>
                    
                    <div className="p-3 flex-grow rounded-b-xl space-y-3 min-h-[400px]">
                        {tasks.map(task => <TaskCard key={task.id} task={task} onEdit={onEditTask} />)}
                        
                        <button onClick={onAddTask} className="w-full flex items-center justify-center gap-2 text-sm p-3 rounded-lg text-slate-400 border border-slate-300 border-dashed hover:bg-white hover:text-orange-500 hover:border-orange-300 transition-all group">
                            <i className="ph-bold ph-plus group-hover:scale-110 transition-transform"></i> Add Task
                        </button>
                    </div>
                </div>
            );
        };

        // --- Improved Timeline View ---
        const TimelineView = ({ tasks, onEditTask, onSaveTask }) => {
            const [startDate, setStartDate] = useState(new Date());
            const [dragState, setDragState] = useState(null); // { type, task, handle, startX, originalStart, originalEnd, hasMoved }
            const dayRef = useRef(null);

            const timeDiff = (d1, d2) => (new Date(d1) - new Date(d2)) / (1000 * 60 * 60 * 24);
            const dates = useMemo(() => { 
                const start = new Date(startDate); start.setDate(start.getDate() - start.getDay()); 
                return Array.from({ length: 28 }).map((_, i) => { 
                    const d = new Date(start); d.setDate(d.getDate() + i); return d; 
                }); 
            }, [startDate]);
            
            const changeWeek = (offset) => setStartDate(prev => { const d = new Date(prev); d.setDate(d.getDate() + (7 * offset)); return d; });

            const handleMouseDown = (e, task, type, handle = null) => {
                e.stopPropagation(); e.preventDefault();
                setDragState({ 
                    type, task, handle, 
                    startX: e.clientX, 
                    originalStart: task.startDate, 
                    originalEnd: task.dueDate,
                    hasMoved: false 
                });
            };

            useEffect(() => {
                const handleMouseMove = (e) => {
                    if (!dragState) return;
                    const dx = Math.abs(e.clientX - dragState.startX);
                    if (dx > 5) setDragState(prev => ({ ...prev, hasMoved: true }));
                };
                
                const handleMouseUp = (e) => {
                    if (!dragState || !dayRef.current) return;
                    const { task, type, handle, originalStart, originalEnd, hasMoved } = dragState;

                    // If it was just a click (no significant move), interpret as Edit action
                    if (!hasMoved && type === 'move') {
                        onEditTask(task);
                        setDragState(null);
                        return;
                    }

                    const dayWidth = dayRef.current.offsetWidth;
                    const dx = e.clientX - dragState.startX;
                    const dayDelta = Math.round(dx / dayWidth);

                    if (dayDelta === 0) { setDragState(null); return; }

                    const finalTask = { ...task };

                    if (type === 'move') {
                        const newStart = new Date(originalStart); newStart.setDate(newStart.getDate() + dayDelta);
                        const newEnd = new Date(originalEnd); newEnd.setDate(newEnd.getDate() + dayDelta);
                        finalTask.startDate = newStart.toISOString().split('T')[0];
                        finalTask.dueDate = newEnd.toISOString().split('T')[0];
                    } else if (type === 'resize') {
                        if (handle === 'start') {
                            const newDate = new Date(originalStart); newDate.setDate(newDate.getDate() + dayDelta);
                            finalTask.startDate = newDate.toISOString().split('T')[0];
                            if (new Date(finalTask.startDate) > new Date(finalTask.dueDate)) finalTask.startDate = originalStart;
                        } else {
                            const newDate = new Date(originalEnd); newDate.setDate(newDate.getDate() + dayDelta);
                            finalTask.dueDate = newDate.toISOString().split('T')[0];
                            if (new Date(finalTask.dueDate) < new Date(finalTask.startDate)) finalTask.dueDate = originalEnd;
                        }
                    }
                    
                    onSaveTask(finalTask, false);
                    setDragState(null);
                };

                window.addEventListener('mousemove', handleMouseMove); window.addEventListener('mouseup', handleMouseUp);
                return () => { window.removeEventListener('mousemove', handleMouseMove); window.removeEventListener('mouseup', handleMouseUp); };
            }, [dragState]);

            return (
                <div className="bg-white rounded-xl p-6 border border-slate-200 shadow-sm overflow-hidden flex flex-col h-[600px]">
                    <div className="flex items-center justify-between mb-6 flex-shrink-0">
                        <h2 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                            <i className="ph-bold ph-chart-bar text-orange-500"></i> Project Timeline
                        </h2>
                        <div className="flex items-center gap-1 bg-slate-100 p-1 rounded-lg border border-slate-200">
                            <button onClick={() => changeWeek(-1)} className="p-1.5 rounded-md hover:bg-white hover:shadow-sm text-slate-500"><i className="ph-bold ph-caret-left"></i></button>
                            <span className="font-semibold text-slate-700 w-40 text-center text-sm">{dates[0].toLocaleDateString('en-AU', {month:'long', year:'numeric'})}</span>
                            <button onClick={() => changeWeek(1)} className="p-1.5 rounded-md hover:bg-white hover:shadow-sm text-slate-500"><i className="ph-bold ph-caret-right"></i></button>
                        </div>
                    </div>
                    
                    <div className="overflow-x-auto timeline-scroll pb-4 flex-grow relative">
                        <div className="grid gap-y-1 min-w-[1200px]" style={{gridTemplateColumns: `200px repeat(${dates.length}, 1fr)`}}>
                            
                            {/* Sticky Header Row */}
                            <div className="sticky left-0 bg-white z-20 font-bold text-slate-400 text-xs p-2 border-r border-slate-200 border-b shadow-sm flex items-center h-10 top-0">TASK</div>
                            {dates.map((date, i) => {
                                const isToday = date.toDateString() === new Date().toDateString();
                                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                                return (
                                    <div key={i} ref={i === 0 ? dayRef : null} 
                                        className={`text-center border-r border-slate-100 border-b py-1 sticky top-0 z-10 h-10 ${isWeekend ? 'bg-slate-50/80' : 'bg-white'} ${isToday ? 'bg-orange-50' : ''}`}>
                                        <p className="text-[10px] text-slate-400 uppercase leading-tight">{date.toLocaleDateString('en-AU', {weekday: 'short'})}</p>
                                        <p className={`text-xs font-bold leading-tight ${isToday ? 'text-orange-600' : 'text-slate-600'}`}>{date.getDate()}</p>
                                        
                                        {/* Today Line Indicator */}
                                        {isToday && (
                                            <div className="absolute top-10 bottom-[-1000px] left-1/2 w-0.5 bg-blue-400 z-0 pointer-events-none opacity-50 transform -translate-x-1/2"></div>
                                        )}
                                    </div>
                                );
                            })}

                            {/* Task Rows */}
                            {tasks.map((task, taskIndex) => {
                                if (!task.startDate || !task.dueDate) return null;
                                const taskStart = new Date(task.startDate); const taskEnd = new Date(task.dueDate);
                                const gridColumnStart = Math.floor(timeDiff(taskStart, dates[0])) + 2;
                                const duration = Math.max(1, Math.ceil(timeDiff(taskEnd, taskStart)) + 1);
                                
                                // Hide if out of view
                                if (gridColumnStart > dates.length + 1 || (gridColumnStart + duration) < 2) return null;
                                
                                const statusColor = task.status === 'Completed' ? 'bg-green-500 border-green-600' : task.status === 'In Progress' ? 'bg-orange-500 border-orange-600' : 'bg-slate-400 border-slate-500';

                                return (
                                    <React.Fragment key={task.id}>
                                        <div className="sticky left-0 bg-white z-10 text-sm font-medium text-slate-600 p-2 pr-4 truncate border-r border-slate-200 border-b border-slate-50 flex items-center hover:bg-slate-50 transition-colors h-10 cursor-pointer" 
                                             style={{gridRow: taskIndex + 2}}
                                             onClick={() => onEditTask(task)}>
                                            {task.title}
                                        </div>
                                        
                                        {/* Grid Background Cells */}
                                        {dates.map((d, i) => {
                                            const isWeekend = d.getDay() === 0 || d.getDay() === 6;
                                            return (
                                                <div key={i} className={`border-r border-slate-100 border-b border-slate-50 h-10 ${isWeekend ? 'bg-slate-50/50' : ''}`} style={{gridRow: taskIndex + 2}}></div>
                                            );
                                        })}
                                        
                                        {/* Task Bar */}
                                        <div className={`h-7 mt-1.5 mx-1 rounded-md flex items-center justify-between relative task-bar ${statusColor} border shadow-sm hover:shadow-md hover:brightness-110 transition-all text-white z-10`} 
                                            style={{ gridColumn: `${Math.max(2, gridColumnStart)} / span ${duration}`, gridRow: taskIndex + 2, cursor: 'grab' }}
                                            onMouseDown={(e) => handleMouseDown(e, task, 'move')}>
                                            
                                            {/* Resize Handles */}
                                            <div className="resize-handle resize-handle-left" onMouseDown={(e) => handleMouseDown(e, task, 'resize', 'start')}></div>
                                            
                                            <div className="px-3 w-full truncate text-xs font-bold drop-shadow-sm pointer-events-none select-none">{task.title}</div>
                                            
                                            <div className="resize-handle resize-handle-right" onMouseDown={(e) => handleMouseDown(e, task, 'resize', 'end')}></div>
                                        </div>
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </div>
                </div>
            )
        };

        const App = () => {
            const [db, setDb] = useState(null);
            const [localUserName, setLocalUserName] = useState(localStorage.getItem('osf-task-user'));
            const [allTasks, setAllTasks] = useState([]);
            const [view, setView] = useState('board');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedTask, setSelectedTask] = useState(null);
            const [newColumnStatus, setNewColumnStatus] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [error, setError] = useState(null);

            useEffect(() => {
                const init = async () => {
                    try {
                        const { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, collection, onSnapshot } = window.firebaseModules;
                        
                        const firebaseConfig = {
                          apiKey: "AIzaSyA-AwiFvSq3_AuDVZE5l1Pn4oAIfZTFmOM",
                          authDomain: "opsf---comms-task-tracker.firebaseapp.com",
                          projectId: "opsf---comms-task-tracker",
                          storageBucket: "opsf---comms-task-tracker.firebasestorage.app",
                          messagingSenderId: "489224390639",
                          appId: "1:489224390639:web:54b9f2772aaef86d32581a",
                          measurementId: "G-PE0JBKHX9W"
                        };
                        
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const dbInstance = getFirestore(app);
                        setDb(dbInstance);

                        // Auth Flow - Anonymous Login Only for Standalone Tool
                        await signInAnonymously(auth);
                        
                        onAuthStateChanged(auth, (user) => { if(user) setIsAuthReady(true); });

                        // Using standard root collection for personal project compatibility
                        const tasksCollection = collection(dbInstance, 'tasks');

                        return onSnapshot(tasksCollection, (snapshot) => {
                            const tasksData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setAllTasks(tasksData);
                        }, (err) => {
                            console.error(err);
                            setError("Could not load tasks. Please refresh.");
                        });

                    } catch (err) {
                        console.error(err);
                        setError("Connection failed. " + err.message);
                    }
                };
                init();
            }, []);

            const columns = useMemo(() => ({
                'To Do': allTasks.filter(t => t.status === 'To Do'),
                'In Progress': allTasks.filter(t => t.status === 'In Progress'),
                'Completed': allTasks.filter(t => t.status === 'Completed'),
            }), [allTasks]);

            const handleLogin = (name) => { setLocalUserName(name); localStorage.setItem('osf-task-user', name); };
            const handleLogout = () => { setLocalUserName(null); localStorage.removeItem('osf-task-user'); };
            
            const handleSaveTask = async (taskData, close = true) => {
                const { collection, doc, addDoc, updateDoc, serverTimestamp } = window.firebaseModules;
                // Using standard root collection
                const tasksCollection = collection(db, 'tasks');
                
                const payload = { ...taskData };
                const id = payload.id; delete payload.id;
                
                if (id) {
                    payload.updatedAt = serverTimestamp();
                    await updateDoc(doc(tasksCollection, id), payload);
                } else {
                    payload.status = newColumnStatus || 'To Do';
                    payload.createdAt = serverTimestamp();
                    payload.updates = [];
                    await addDoc(tasksCollection, payload);
                }
                if (close) { setIsModalOpen(false); setSelectedTask(null); }
            };

            const handleDeleteTask = async (id) => {
                const { collection, doc, deleteDoc } = window.firebaseModules;
                setIsModalOpen(false);
                await deleteDoc(doc(db, 'tasks', id));
            };
            
            const handleDrop = (taskId, newStatus) => {
                const task = allTasks.find(t => t.id === taskId);
                if (task && task.status !== newStatus) handleSaveTask({ ...task, status: newStatus }, false);
            };

            if (!localUserName) return <LoginScreen onLogin={handleLogin} isAuthReady={isAuthReady} error={error} />;

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-6 w-full">
                    
                    {/* Toolbar */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-full bg-gradient-to-tr from-orange-400 to-red-400 flex items-center justify-center font-bold text-white text-xs shadow-sm">
                                {localUserName.charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <h1 className="text-xl font-bold text-slate-800">Task Board</h1>
                                <p className="text-xs text-slate-500">Logged in as {localUserName}</p>
                            </div>
                        </div>

                        <div className="flex items-center gap-3">
                            <div className="flex bg-white rounded-lg border border-slate-200 p-1 shadow-sm">
                                <button onClick={() => setView('board')} className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-all ${view === 'board' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <i className="ph-bold ph-kanban"></i> Board
                                </button>
                                <button onClick={() => setView('timeline')} className={`px-3 py-1.5 rounded-md text-sm font-medium flex items-center gap-2 transition-all ${view === 'timeline' ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-50'}`}>
                                    <i className="ph-bold ph-chart-bar"></i> Timeline
                                </button>
                            </div>
                            <button onClick={handleLogout} className="p-2 text-slate-400 hover:text-red-500 transition-colors" title="Sign Out">
                                <i className="ph-bold ph-sign-out text-xl"></i>
                            </button>
                        </div>
                    </div>

                    {view === 'board' ? (
                        <div className="flex flex-col lg:flex-row gap-6 items-start">
                            {['To Do', 'In Progress', 'Completed'].map(status => (
                                <KanbanColumn key={status} title={status} tasks={columns[status]} 
                                    onAddTask={() => { setSelectedTask(null); setNewColumnStatus(status); setIsModalOpen(true); }}
                                    onEditTask={(t) => { setSelectedTask(t); setNewColumnStatus(null); setIsModalOpen(true); }}
                                    onDrop={(id) => handleDrop(id, status)} />
                            ))}
                        </div>
                    ) : (
                        <TimelineView tasks={allTasks} onEditTask={(t) => { setSelectedTask(t); setNewColumnStatus(null); setIsModalOpen(true); }} onSaveTask={handleSaveTask} />
                    )}

                    {isModalOpen && <TaskModal task={selectedTask} onClose={() => setIsModalOpen(false)} onSave={handleSaveTask} onDelete={handleDeleteTask} currentUser={localUserName} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
