<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .kanban-column { min-height: 400px; }
        .timeline-scroll::-webkit-scrollbar { height: 8px; }
        .timeline-scroll::-webkit-scrollbar-track { background: #374151; }
        .timeline-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white">
    <div id="root"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        // --- CONFIGURATION: PASTE YOUR GOOGLE APPS SCRIPT DEPLOYMENT URL HERE ---
        const appsScriptUrl = "https://script.google.com/macros/s/AKfycbzW-S_FhCmMyUZNsqRKRdTEj2jVtbTAZ0bLctLNGPj9L2PNLcruiP-UEy00Bq5pYG5L/exec";
        // ---------------------------------------------------------

        // --- Icon Components ---
        const Icon = ({ children, ...props }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>;
        const Plus = (props) => <Icon {...props}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const X = (props) => <Icon {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></Icon>;
        const ChevronsUp = (props) => <Icon {...props}><path d="m17 11-5-5-5 5"/><path d="m17 18-5-5-5 5"/></Icon>;
        const Equal = (props) => <Icon {...props}><line x1="5" x2="19" y1="9" y2="9"/><line x1="5" x2="19" y1="15" y2="15"/></Icon>;
        const Calendar = (props) => <Icon {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>;
        const LogOut = (props) => <Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></Icon>;
        const Loader = (props) => <Icon {...props} className="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></Icon>;

        // --- Child Components ---
        const priorityMap = {
            High: { icon: <ChevronsUp size={16} className="text-red-400"/>, text: 'High', color: 'text-red-400' },
            Medium: { icon: <Equal size={16} className="text-yellow-400"/>, text: 'Medium', color: 'text-yellow-400' },
            Low: { icon: <Equal size={16} className="text-green-400"/>, text: 'Low', color: 'text-green-400' }
        };
        const statusMap = {
            'To Do': { color: 'bg-red-500', borderColor: 'border-red-500' },
            'In Progress': { color: 'bg-yellow-500', borderColor: 'border-yellow-500' },
            'Completed': { color: 'bg-green-500', borderColor: 'border-green-500' }
        };

        const TaskModal = ({ task, onClose, onSave }) => {
            const { useState, useEffect } = React;
            const today = new Date().toISOString().split('T')[0];
            const [title, setTitle] = useState('');
            const [description, setDescription] = useState('');
            const [priority, setPriority] = useState('Medium');
            const [startDate, setStartDate] = useState(today);
            const [dueDate, setDueDate] = useState(today);
            const [newUpdate, setNewUpdate] = useState('');
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                if (task) {
                    setTitle(task.title || '');
                    setDescription(task.description || '');
                    setPriority(task.priority || 'Medium');
                    setStartDate(task.startDate || today);
                    setDueDate(task.dueDate || today);
                } else {
                    setTitle('');
                    setDescription('');
                    setPriority('Medium');
                    setStartDate(today);
                    setDueDate(today);
                }
            }, [task, today]);

            const handleSave = async () => {
                setIsSaving(true);
                await onSave({ ...(task || {}), title, description, priority, startDate, dueDate });
            };

            const handleAddUpdate = async () => {
                if (!newUpdate.trim()) return;
                setIsSaving(true);
                const update = { text: newUpdate, date: new Date().toISOString() };
                await onSave({ ...task, updates: [...(task.updates || []), update] });
                setNewUpdate('');
                setIsSaving(false); 
            };

            return (
                <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
                    <div className="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-500 hover:text-white"><X size={24} /></button>
                        <h2 className="text-2xl font-bold mb-6">{task?.id ? 'Edit Task' : 'Create New Task'}</h2>
                        <div className="space-y-4">
                            <div>
                                <label htmlFor="title" className="block text-sm font-medium text-gray-300 mb-1">Title</label>
                                <input id="title" type="text" value={title} onChange={e => setTitle(e.target.value)} className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white" />
                            </div>
                            <div>
                                <label htmlFor="description" className="block text-sm font-medium text-gray-300 mb-1">Description</label>
                                <textarea id="description" value={description} onChange={e => setDescription(e.target.value)} className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white" />
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label htmlFor="priority" className="block text-sm font-medium text-gray-300 mb-1">Priority</label>
                                    <select id="priority" value={priority} onChange={e => setPriority(e.target.value)} className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white">
                                        <option>Low</option>
                                        <option>Medium</option>
                                        <option>High</option>
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="startDate" className="block text-sm font-medium text-gray-300 mb-1">Start Date</label>
                                    <input id="startDate" type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white" />
                                </div>
                                <div>
                                    <label htmlFor="dueDate" className="block text-sm font-medium text-gray-300 mb-1">Due Date</label>
                                    <input id="dueDate" type="date" value={dueDate} onChange={e => setDueDate(e.target.value)} className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white" />
                                </div>
                            </div>
                        </div>
                        {task?.id && (
                            <div className="mt-6 pt-4 border-t border-gray-700">
                                <h3 className="text-lg font-semibold text-blue-400 mb-3">Updates</h3>
                                <div className="space-y-3 max-h-40 overflow-y-auto">
                                    {(task.updates || []).map((update, idx) => (
                                        <div key={idx} className="bg-gray-700 p-2 rounded-md text-sm flex flex-col">
                                            <span>{update.text}</span>
                                            <span className="text-xs text-gray-400">{new Date(update.date).toLocaleString()}</span>
                                        </div>
                                    ))}
                                </div>
                                <div className="flex items-center gap-2 mt-3">
                                    <input type="text" className="flex-grow px-3 py-2 rounded-lg bg-gray-700 text-white" value={newUpdate} onChange={e => setNewUpdate(e.target.value)} placeholder="Add update..." />
                                    <button onClick={handleAddUpdate} disabled={isSaving} className="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-3 rounded-lg">{isSaving ? 'Saving...' : 'Add'}</button>
                                </div>
                            </div>
                        )}
                        <div className="flex justify-end pt-6">
                            <button onClick={handleSave} disabled={isSaving} className="bg-green-600 hover:bg-green-700 font-bold py-2 px-6 rounded-lg flex items-center gap-2">
                                {isSaving && <Loader size={20}/>} {task?.id ? 'Save Changes' : 'Create Task'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const TaskCard = ({ task, onEdit }) => {
            const handleDragStart = (e) => { e.dataTransfer.setData('taskId', task.id); };
            const priority = priorityMap[task.priority] || priorityMap.Medium;
            const today = new Date(); today.setHours(0,0,0,0);
            const dueDate = new Date(task.dueDate);
            const isOverdue = dueDate < today;
            const isDueSoon = !isOverdue && (dueDate - today) / (1000 * 60 * 60 * 24) <= 3;
            const dateColor = isOverdue ? 'text-red-400' : isDueSoon ? 'text-yellow-400' : 'text-gray-400';

            return (
                <div draggable onDragStart={handleDragStart} onClick={() => onEdit(task)} className="bg-gray-800 p-3 rounded-lg shadow-md cursor-pointer hover:bg-gray-700/50 transition-colors border-l-4 mb-2" style={{ borderColor: statusMap[task.status]?.color }}>
                    <div className="flex justify-between items-start">
                        <p className="font-bold text-gray-200 mb-2 pr-2">{task.title}</p>
                        {task.assignedTo && <span className="text-xs bg-gray-700 text-blue-300 font-bold px-2 py-1 rounded-lg">{task.assignedTo}</span>}
                    </div>
                    <div className="flex justify-between items-center text-xs">
                        <div className={`flex items-center gap-1.5 font-semibold ${priority.color}`}>
                            {priority.icon} {priority.text}
                        </div>
                        {task.dueDate && (
                            <div className={`flex items-center gap-1.5 font-semibold ${dateColor}`}>
                                <Calendar size={14}/> {new Date(task.dueDate).toLocaleDateString('en-AU', {day:'numeric', month:'short'})}
                            </div>
                        )}
                        <div className="flex items-center gap-1.5 text-gray-400"><MessageSquare size={14}/> {task.updates?.length || 0}</div>
                    </div>
                </div>
            );
        };

        const KanbanColumn = ({ title, tasks, onAddTask, onEditTask, onDrop }) => {
            const [isDragOver, setIsDragOver] = React.useState(false);
            const handleDragOver = (e) => { e.preventDefault(); setIsDragOver(true); };
            const handleDragLeave = () => setIsDragOver(false);
            const handleDrop = (e) => { e.preventDefault(); onDrop(e.dataTransfer.getData('taskId')); setIsDragOver(false); };

            return (
                <div className={`bg-gray-800/50 rounded-xl flex-1 transition-all ${isDragOver ? 'bg-blue-900/50' : ''}`} onDragOver={handleDragOver} onDragLeave={handleDragLeave} onDrop={handleDrop}>
                    <div className={`flex items-center justify-between p-4 border-b-2 ${statusMap[title].borderColor}`}>
                        <h2 className="text-lg font-bold text-white">{title}</h2>
                        <span className="text-xs text-gray-300 font-semibold">{tasks.length} tasks</span>
                    </div>
                    <div className="p-4 space-y-3 kanban-column">
                        {tasks.map(task => <TaskCard key={task.id} task={task} onEdit={onEditTask} />)}
                        <button onClick={onAddTask} className="w-full flex items-center gap-2 mt-2 p-2 rounded-md bg-blue-700 hover:bg-blue-800 text-white font-bold">
                            <Plus size={18}/> Add Task
                        </button>
                    </div>
                </div>
            );
        };

        const TimelineView = ({ tasks, onEditTask }) => {
            const { useState, useMemo } = React;
            const [startDate, setStartDate] = useState(new Date());
            const timeDiff = (d1, d2) => (new Date(d1) - new Date(d2)) / (1000 * 60 * 60 * 24);
            const dates = useMemo(() => {
                const start = new Date(startDate); start.setDate(start.getDate() - start.getDay());
                return Array.from({ length: 28 }).map((_, i) => {
                    const d = new Date(start); d.setDate(start.getDate() + i);
                    return d;
                });
            }, [startDate]);
            const changeWeek = (offset) => setStartDate(prev => {
                const d = new Date(prev);
                d.setDate(d.getDate() + (7 * offset));
                return d;
            });

            return (
                <div className="bg-gray-800/50 rounded-xl p-4">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-xl font-bold text-white">Project Timeline</h2>
                        <div className="flex items-center gap-2">
                            <button onClick={() => changeWeek(-1)} className="bg-gray-700 rounded-lg px-2 py-1">&lt; Prev</button>
                            <button onClick={() => changeWeek(1)} className="bg-gray-700 rounded-lg px-2 py-1">Next &gt;</button>
                        </div>
                    </div>
                    <div className="overflow-x-auto timeline-scroll">
                        <div className="grid gap-2 min-w-[1200px]" style={{gridTemplateColumns: `150px repeat(${dates.length}, 1fr)`}}>
                            <div className="sticky left-0 bg-gray-900 text-gray-400 font-bold py-2 px-2">Tasks</div>
                            {dates.map((d, i) => (
                                <div key={i} className="text-xs text-gray-400 px-2 py-2 text-center">{d.toLocaleDateString('en-AU', {day:'numeric', month:'short'})}</div>
                            ))}
                            {tasks.map((task, taskIndex) => {
                                if (!task.startDate || !task.dueDate) return null;
                                const taskStart = new Date(task.startDate); const taskEnd = new Date(task.dueDate);
                                const gridColumnStart = Math.floor(timeDiff(taskStart, dates[0])) + 2;
                                const duration = Math.ceil(timeDiff(taskEnd, taskStart)) + 1;
                                if (gridColumnStart > dates.length || (gridColumnStart + duration) < 2) return null;
                                return (
                                    <React.Fragment key={task.id}>
                                        <div className="sticky left-0 bg-gray-800/50 text-sm font-semibold text-gray-300 p-2 truncate flex items-center" style={{gridRow: taskIndex+2, gridColumn: "1 / span 1"}}>
                                            <span className="cursor-pointer underline" onClick={() => onEditTask(task)}>{task.title}</span>
                                        </div>
                                        <div className="rounded-lg bg-blue-700 text-white font-bold flex items-center justify-center"
                                             style={{
                                                 gridRow: taskIndex+2,
                                                 gridColumn: `${Math.max(2, gridColumnStart)} / span ${Math.max(1, Math.min(duration, dates.length-gridColumnStart+2))}`
                                             }}>
                                            {task.assignedTo}
                                        </div>
                                    </React.Fragment>
                                );
                            })}
                        </div>
                    </div>
                </div>
            )
        };

        const LoginScreen = ({ onLogin }) => {
            const [name, setName] = React.useState('');
            const handleSubmit = (e) => { e.preventDefault(); if (name.trim()) onLogin(name.trim()); };
            return (
                <div className="min-h-screen flex items-center justify-center">
                    <div className="bg-gray-800 p-8 rounded-xl shadow-lg w-full max-w-sm">
                        <h1 className="text-2xl font-bold text-white text-center mb-6">Project Tracker</h1>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label htmlFor="name" className="block text-sm font-medium text-gray-300 mb-1">Your Name</label>
                                <input id="name" type="text" value={name} onChange={e => setName(e.target.value)} className="w-full px-3 py-2 rounded-lg bg-gray-700 text-white" />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">View Projects</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const { useState, useEffect, useMemo } = React;
            const [allTasks, setAllTasks] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [selectedTask, setSelectedTask] = useState(null);
            const [newColumnStatus, setNewColumnStatus] = useState(null);
            const [view, setView] = useState('board');
            const [currentUser, setCurrentUser] = useState(localStorage.getItem('project-tracker-user'));
            const [error, setError] = useState(null);

            // Fetch tasks from Apps Script endpoint
            const fetchTasks = async () => {
                if (!appsScriptUrl || appsScriptUrl.includes("PASTE_YOUR")) {
                    setError("Configuration Error: Please paste your Google Apps Script URL.");
                    setIsLoading(false);
                    return;
                }
                setIsLoading(true);
                try {
                    const response = await fetch(appsScriptUrl, { method: 'GET', mode: 'cors' });
                    if (!response.ok) throw new Error('Network response was not ok. Check sharing permissions.');
                    const tasks = await response.json();
                    setAllTasks(Array.isArray(tasks) ? tasks.filter(t => t.id) : []);
                    setError(null);
                } catch (err) {
                    setError(`Could not fetch tasks: ${err.message}`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            useEffect(() => { fetchTasks(); }, []);

            const userTasks = useMemo(() => {
                if (currentUser === 'Admin') return allTasks;
                return allTasks.filter(t => t.assignedTo === currentUser);
            }, [allTasks, currentUser]);

            const columns = useMemo(() => ({
                'To Do': userTasks.filter(t => t.status === 'To Do'),
                'In Progress': userTasks.filter(t => t.status === 'In Progress'),
                'Completed': userTasks.filter(t => t.status === 'Completed')
            }), [userTasks]);

            const handleLogin = (name) => { setCurrentUser(name); localStorage.setItem('project-tracker-user', name); };
            const handleLogout = () => { setCurrentUser(null); localStorage.removeItem('project-tracker-user'); };
            
            const handleOpenModalForNew = (status) => { setSelectedTask(null); setNewColumnStatus(status); setIsModalOpen(true); };
            const handleOpenModalForEdit = (task) => { setSelectedTask(task); setNewColumnStatus(null); setIsModalOpen(true); };
            const handleCloseModal = () => { setIsModalOpen(false); setSelectedTask(null); setNewColumnStatus(null); };

            const handleSaveTask = async (taskData) => {
                if (!appsScriptUrl || appsScriptUrl.includes("PASTE_YOUR")) {
                    alert("Configuration Error: Please paste your Google Apps Script URL.");
                    return;
                }
                const payload = { ...taskData };
                if (!payload.id) {
                    payload.status = newColumnStatus;
                    payload.updates = [];
                    payload.assignedTo = currentUser === 'Admin' ? '' : currentUser;
                }
                try {
                    const response = await fetch(appsScriptUrl, {
                        method: 'POST',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        mode: 'cors',
                    });
                    if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(result.message);
                    await fetchTasks();
                } catch (err) {
                    setError(`Failed to save task: ${err.message}`);
                } finally {
                    handleCloseModal();
                }
            };

            const handleDrop = (taskId, newStatus) => {
                const taskToUpdate = allTasks.find(t => t.id === taskId);
                if (taskToUpdate) handleSaveTask({ ...taskToUpdate, status: newStatus });
            };

            if (!currentUser) { return <LoginScreen onLogin={handleLogin} />; }

            return (
                <div className="p-4 md:p-8">
                    <header className="flex items-center justify-between mb-8">
                        <div className="flex items-center gap-4">
                            <h1 className="text-3xl font-bold text-white">Project Tracker</h1>
                            <span className="bg-gray-700 text-blue-300 font-bold px-3 py-1 rounded-lg">
                                {currentUser === 'Admin' ? 'Admin View - All Tasks' : `${currentUser}'s Tasks`}
                            </span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center p-1 bg-gray-800 rounded-lg">
                                <button onClick={() => setView('board')} className={`p-2 rounded-md transition-colors ${view === 'board' ? 'bg-blue-700 text-white' : 'text-gray-400'}`}>Board</button>
                                <button onClick={() => setView('timeline')} className={`p-2 rounded-md transition-colors ${view === 'timeline' ? 'bg-blue-700 text-white' : 'text-gray-400'}`}>Timeline</button>
                            </div>
                            <button onClick={() => handleOpenModalForNew('To Do')} className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                                <Plus size={18}/> New Task
                            </button>
                            <button onClick={handleLogout} className="p-2 rounded-full bg-gray-700 hover:bg-gray-600" title="Logout"><LogOut size={20}/></button>
                        </div>
                    </header>
                    {error && <div className="bg-red-800 border border-red-600 text-white p-4 rounded-lg mb-4">{error}</div>}
                    {isLoading ? (
                        <div className="flex-grow flex items-center justify-center text-white text-lg">
                            <Loader size={24} className="mr-2"/>Loading Projects...
                        </div>
                    ) : (
                        <main>
                            {view === 'board' ? (
                                <div className="flex flex-col md:flex-row gap-6">
                                    <KanbanColumn title="To Do" tasks={columns['To Do']} onAddTask={() => handleOpenModalForNew('To Do')} onEditTask={handleOpenModalForEdit} onDrop={taskId => handleDrop(taskId, 'To Do')} />
                                    <KanbanColumn title="In Progress" tasks={columns['In Progress']} onAddTask={() => handleOpenModalForNew('In Progress')} onEditTask={handleOpenModalForEdit} onDrop={taskId => handleDrop(taskId, 'In Progress')} />
                                    <KanbanColumn title="Completed" tasks={columns['Completed']} onAddTask={() => handleOpenModalForNew('Completed')} onEditTask={handleOpenModalForEdit} onDrop={taskId => handleDrop(taskId, 'Completed')} />
                                </div>
                            ) : (
                                <TimelineView tasks={userTasks} onEditTask={handleOpenModalForEdit} />
                            )}
                        </main>
                    )}
                    {isModalOpen && <TaskModal task={selectedTask} onClose={handleCloseModal} onSave={handleSaveTask} />}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
