<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Content Approval Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 40;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-pending { background-color: #fef9c3; color: #854d0e; }
        .status-approved { background-color: #dcfce7; color: #166534; }
        .status-rejected { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app-loading" class="flex items-center justify-center h-screen">
        <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="ml-3 text-lg">Loading App...</p>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="hidden min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8 bg-white p-10 rounded-xl shadow-lg">
            <div>
                <svg class="mx-auto h-12 w-auto text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                </svg>
                <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                    Content Approval Tool
                </h2>
            </div>
            <div id="auth-container" class="mt-8 space-y-6">
                 <!-- Auth content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Main App Screen -->
    <div id="main-app" class="hidden">
        <nav class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                        </svg>
                        <span class="ml-3 font-bold text-xl">Approval Workflow</span>
                    </div>
                    <div class="flex items-center">
                        <span id="user-info" class="text-sm text-gray-600 mr-4"></span>
                        <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Logout</button>
                    </div>
                </div>
            </div>
        </nav>
        
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="px-4 py-6 sm:px-0">
                <div class="flex justify-between items-center mb-6">
                    <h1 id="page-title" class="text-3xl font-bold text-gray-900">Dashboard</h1>
                    <button id="new-post-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center">
                         <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        New Post
                    </button>
                </div>

                <div class="mb-6 border-b border-gray-200">
                    <nav id="view-tabs" class="-mb-px flex space-x-8" aria-label="Tabs">
                         <!-- Tabs will be injected here -->
                    </nav>
                </div>
                
                <div id="content-area">
                    <!-- Posts will be rendered here -->
                </div>
                 <div id="no-content-message" class="hidden text-center py-16">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No content yet</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by creating a new post.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- New Post Modal -->
    <div id="post-modal-backdrop" class="modal-backdrop"></div>
    <div id="post-modal" class="modal bg-white rounded-lg shadow-xl w-11/12 md:max-w-2xl">
        <div class="p-6">
            <div class="flex justify-between items-center pb-3">
                <p class="text-2xl font-bold">New Content Submission</p>
                <button id="close-modal-button" class="modal-close cursor-pointer z-50">
                    <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                        <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                    </svg>
                </button>
            </div>

            <form id="post-form" class="space-y-4">
                <div>
                    <label for="platform" class="block text-sm font-medium text-gray-700">Platform</label>
                    <select id="platform" name="platform" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                        <option>Facebook</option>
                        <option>Instagram</option>
                        <option>Twitter / X</option>
                        <option>Newsletter</option>
                    </select>
                </div>
                <div>
                    <label for="post-content" class="block text-sm font-medium text-gray-700">Content</label>
                    <textarea id="post-content" name="post-content" rows="8" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="Write your social media post here... Markdown is supported." required></textarea>
                </div>
                 <div>
                    <label for="image-url" class="block text-sm font-medium text-gray-700">Image URL (Optional)</label>
                    <input type="url" id="image-url" name="image-url" class="mt-1 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" placeholder="https://example.com/image.jpg">
                </div>
                <div>
                    <label for="approver" class="block text-sm font-medium text-gray-700">Assign Approver</label>
                    <select id="approver" name="approver" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" required>
                        <!-- Approvers will be populated here -->
                    </select>
                </div>
                <div class="pt-4 flex justify-end">
                    <button type="button" id="cancel-modal-button" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Submit for Approval</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            doc, 
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot, 
            query, 
            where,
            serverTimestamp,
            orderBy
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INITIALIZATION ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{"apiKey":"AIzaSyAF44-oMKqTKPcMgOuKfJJqUTJz9JYTHAg","authDomain":"osf---availability-roster.firebaseapp.com","projectId":"osf---availability-roster","storageBucket":"osf---availability-roster.firebasestorage.app","messagingSenderId":"1069751236100","appId":"1:1069751236100:web:6a2c9a1570f99927e86751", measurementId: "G-JT3PMQ0W6T"}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'social-approval-app';

        let app, auth, db;
        let currentUser = null;
        let unsubscribePosts = () => {};
        
        const markdownConverter = new showdown.Converter();

        // --- UI ELEMENTS ---
        const loadingScreen = document.getElementById('app-loading');
        const authScreen = document.getElementById('auth-screen');
        const mainAppScreen = document.getElementById('main-app');
        const authContainer = document.getElementById('auth-container');
        const contentArea = document.getElementById('content-area');
        const noContentMessage = document.getElementById('no-content-message');
        const viewTabsContainer = document.getElementById('view-tabs');

        const postModal = document.getElementById('post-modal');
        const postModalBackdrop = document.getElementById('post-modal-backdrop');
        
        // --- APP STATE ---
        let users = [];
        let currentView = 'pending'; // 'pending', 'approved', 'rejected', 'mine'

        // --- AUTHENTICATION ---
        function showAuthForm(isLogin = true) {
            authContainer.innerHTML = `
                <input type="hidden" name="remember" value="true">
                <div class="rounded-md shadow-sm -space-y-px">
                    ${!isLogin ? `
                    <div>
                        <label for="name" class="sr-only">Full Name</label>
                        <input id="name" name="name" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Full Name">
                    </div>` : ''}
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 ${isLogin ? 'rounded-t-md' : ''} focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="Password">
                    </div>
                </div>
                <p id="auth-error" class="text-red-500 text-sm mt-2"></p>
                <div>
                    <button type="submit" id="auth-submit-button" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        ${isLogin ? 'Sign in' : 'Register'}
                    </button>
                </div>
                <div class="text-sm text-center">
                    <a href="#" id="auth-toggle-link" class="font-medium text-blue-600 hover:text-blue-500">
                        ${isLogin ? "Don't have an account? Register" : "Already have an account? Sign in"}
                    </a>
                </div>
            `;

            document.getElementById('auth-toggle-link').addEventListener('click', (e) => {
                e.preventDefault();
                showAuthForm(!isLogin);
            });

            document.getElementById('auth-submit-button').addEventListener('click', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email-address').value;
                const password = document.getElementById('password').value;
                const name = !isLogin ? document.getElementById('name').value : null;
                const errorEl = document.getElementById('auth-error');
                errorEl.textContent = '';

                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        if (!name) {
                            errorEl.textContent = "Please enter your full name.";
                            return;
                        }
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await updateProfile(userCredential.user, { displayName: name });
                        // Create a user document in Firestore
                        await setDoc(doc(db, "users", userCredential.user.uid), {
                            uid: userCredential.user.uid,
                            email: userCredential.user.email,
                            displayName: name,
                            role: 'submitter' // Default role
                        });
                    }
                } catch (error) {
                    console.error("Auth error:", error);
                    errorEl.textContent = error.message;
                }
            });
        }
        
        // --- UI RENDERING ---

        function renderTabs() {
            const tabs = [
                { id: 'pending', name: 'Pending Approval' },
                { id: 'approved', name: 'Approved Content' },
                { id: 'rejected', name: 'Rejected Content' },
                { id: 'mine', name: 'My Submissions' },
            ];
            viewTabsContainer.innerHTML = tabs.map(tab => `
                <a href="#" data-view="${tab.id}" class="view-tab ${currentView === tab.id ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    ${tab.name}
                </a>
            `).join('');
            
            document.querySelectorAll('.view-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    currentView = e.target.dataset.view;
                    renderTabs();
                    fetchAndRenderPosts();
                });
            });
        }

        function renderPosts(posts) {
            contentArea.innerHTML = '';
             if (posts.length === 0) {
                noContentMessage.classList.remove('hidden');
                return;
            }
            noContentMessage.classList.add('hidden');

            const postGrid = document.createElement('div');
            postGrid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';

            posts.forEach(post => {
                const submitter = users.find(u => u.uid === post.submitterId);
                const approver = users.find(u => u.uid === post.approverId);
                const isApprover = currentUser && currentUser.uid === post.approverId;
                const canTakeAction = isApprover && post.status === 'pending';
                
                const postCard = document.createElement('div');
                postCard.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col';
                postCard.innerHTML = `
                    <div class="p-5 flex-grow">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-sm font-bold text-blue-700 bg-blue-100 py-1 px-3 rounded-full">${post.platform}</span>
                            <span class="status-badge status-${post.status}">${post.status}</span>
                        </div>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post image" class="rounded-md my-3 max-h-48 w-full object-cover" onerror="this.style.display='none'">` : ''}
                        <div class="prose prose-sm max-w-none text-gray-700 mt-3">${markdownConverter.makeHtml(post.content)}</div>
                    </div>
                    <div class="bg-gray-50 p-4 border-t text-xs text-gray-500">
                        <p><strong>Submitted by:</strong> ${submitter ? submitter.displayName : 'Unknown'}</p>
                        <p><strong>Assigned to:</strong> ${approver ? approver.displayName : 'Unknown'}</p>
                        <p><strong>Submitted on:</strong> ${post.submittedAt ? new Date(post.submittedAt.toDate()).toLocaleString() : 'N/A'}</p>
                        ${post.actionAt ? `<p><strong>${post.status} on:</strong> ${new Date(post.actionAt.toDate()).toLocaleString()}</p>`: ''}
                    </div>
                    ${canTakeAction ? `
                    <div class="p-3 bg-gray-100 flex justify-end space-x-2">
                        <button data-id="${post.id}" class="reject-button bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">Reject</button>
                        <button data-id="${post.id}" class="approve-button bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-sm">Approve</button>
                    </div>
                    ` : ''}
                `;
                postGrid.appendChild(postCard);
            });
            contentArea.appendChild(postGrid);
            
            // Add event listeners for action buttons
            document.querySelectorAll('.approve-button').forEach(button => {
                button.addEventListener('click', () => handlePostAction(button.dataset.id, 'approved'));
            });
            document.querySelectorAll('.reject-button').forEach(button => {
                button.addEventListener('click', () => handlePostAction(button.dataset.id, 'rejected'));
            });
        }
        
        function updateApproverDropdown() {
            const approverSelect = document.getElementById('approver');
            approverSelect.innerHTML = '<option value="">Select an approver</option>';
            users.forEach(user => {
                // In a real app, you'd filter by users with an 'approver' role
                const option = document.createElement('option');
                option.value = user.uid;
                option.textContent = user.displayName;
                approverSelect.appendChild(option);
            });
        }

        // --- DATA HANDLING ---
        
        async function fetchUsers() {
            const usersRef = collection(db, 'users');
            onSnapshot(usersRef, (snapshot) => {
                 users = snapshot.docs.map(doc => doc.data());
                 updateApproverDropdown();
            });
        }

        function fetchAndRenderPosts() {
            unsubscribePosts(); // Unsubscribe from previous listener
            
            const postsRef = collection(db, "posts");
            let q;

            switch(currentView) {
                case 'pending':
                    q = query(postsRef, where("status", "==", "pending"), orderBy("submittedAt", "desc"));
                    break;
                case 'approved':
                    q = query(postsRef, where("status", "==", "approved"), orderBy("actionAt", "desc"));
                    break;
                case 'rejected':
                    q = query(postsRef, where("status", "==", "rejected"), orderBy("actionAt", "desc"));
                    break;
                case 'mine':
                    q = query(postsRef, where("submitterId", "==", currentUser.uid), orderBy("submittedAt", "desc"));
                    break;
                default:
                    q = query(postsRef, where("status", "==", "pending"), orderBy("submittedAt", "desc"));
            }

            unsubscribePosts = onSnapshot(q, (querySnapshot) => {
                const posts = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderPosts(posts);
            }, (error) => {
                console.error("Error fetching posts:", error);
                contentArea.innerHTML = `<p class="text-red-500">Error loading content. Please check the console.</p>`;
            });
        }

        async function handlePostSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const newPost = {
                platform: form.platform.value,
                content: form['post-content'].value,
                imageUrl: form['image-url'].value,
                approverId: form.approver.value,
                submitterId: currentUser.uid,
                status: 'pending',
                submittedAt: serverTimestamp(),
                actionAt: null
            };

            try {
                await addDoc(collection(db, "posts"), newPost);
                closeModal();
                form.reset();
            } catch (error) {
                console.error("Error adding document: ", error);
                alert("Failed to submit post.");
            }
        }
        
        async function handlePostAction(postId, newStatus) {
            if (!['approved', 'rejected'].includes(newStatus)) return;
            
            try {
                const postRef = doc(db, "posts", postId);
                await updateDoc(postRef, {
                    status: newStatus,
                    actionAt: serverTimestamp()
                });
            } catch (error) {
                console.error("Error updating document:", error);
                alert(`Failed to ${newStatus} post.`);
            }
        }

        // --- MODAL ---
        function openModal() {
            postModal.style.display = 'block';
            postModalBackdrop.style.display = 'block';
        }

        function closeModal() {
            postModal.style.display = 'none';
            postModalBackdrop.style.display = 'none';
            document.getElementById('post-form').reset();
        }

        // --- INITIALIZATION & EVENT LISTENERS ---
        function initApp() {
            document.getElementById('new-post-button').addEventListener('click', openModal);
            document.getElementById('close-modal-button').addEventListener('click', closeModal);
            document.getElementById('cancel-modal-button').addEventListener('click', closeModal);
            postModalBackdrop.addEventListener('click', closeModal);
            document.getElementById('post-form').addEventListener('submit', handlePostSubmit);
            document.getElementById('logout-button').addEventListener('click', () => signOut(auth));
            
            renderTabs();
            fetchUsers();
            fetchAndRenderPosts();
        }

        function showApp() {
            loadingScreen.style.display = 'none';
            mainAppScreen.classList.remove('hidden');
            authScreen.classList.add('hidden');
        }

        function showLogin() {
            loadingScreen.style.display = 'none';
            mainAppScreen.classList.add('hidden');
            authScreen.classList.remove('hidden');
            showAuthForm();
        }

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-info').textContent = `Logged in as ${user.displayName || user.email}`;
                    showApp();
                    initApp();
                } else {
                    currentUser = null;
                    unsubscribePosts();
                    showLogin();
                }
            });
        } catch(e) {
            console.error("Firebase initialization failed:", e);
            document.getElementById('app-loading').innerHTML = '<p class="text-red-500 text-lg">Error: Firebase configuration is missing or invalid. App cannot start.</p>';
        }

    </script>

</body>
</html>

